---
title: "Methods and Results"
author: "Douglas Lawton"
date: today
format:
  html:
    toc: true
    toc-depth: 2
    number-sections: true
    fig-cap-location: bottom
    theme: cosmo
  docx:
    toc: false
    number-sections: true
editor: source
crossref:
  custom:
    - kind: float
      key: fig
      latex-env: fig
      reference-prefix: Figure
      space-before-numbering: true
      latex-list-of-description: Figure
    - kind: float
      key: suppfig
      latex-env: suppfig
      reference-prefix: Supplementary Figure 
      space-before-numbering: true
      latex-list-of-description: Supplementary Figure
    - kind: float
      key: tbl
      latex-env: tbl
      reference-prefix: Table
      space-before-numbering: true
      latex-list-of-description: Table
    - kind: float
      key: supptbl
      latex-env: supptbl
      reference-prefix: Supplementary Table
      space-before-numbering: true
      latex-list-of-description: Supplementary Table
---

```{r}
#| label: gloabl settings
#| echo: false
#| results: "hide"
#| message: false
#| warning: false

library(tidyverse)
library(ggpubr)
library(patchwork)
library(here)
library(mgcv)
library(knitr)
library(kableExtra)
library(gratia)   
library(cowplot)
library(glue)
library(gt)


# --- Set Root Directory for Project ---
here::i_am("README.md")  # Anchor project for reproducible paths

# --- Custom Color Palette ---
pink <- '#ff8080'
green <- '#2fc09b'


plant_colors <- c(green, pink)

base_size = 16
geom_text_size = 7
```

```{r reading in data}
#| echo: false
#| warning: false
#| message: false
#| results: "hide"

# ============================================================
#                 DATA LOADING HELPERS
# ============================================================

# Load a CSV relative to project root
load_csv <- function(...) {
  read_csv(here(...), show_col_types = FALSE)
}

# Generalized function for loading model outputs (emms, letters, summary, contrasts)
load_model_data <- function(base_dir, name = NULL) {
  base_path <- if (is.null(name)) here(base_dir) else here(glue("{base_dir}/{name}"))
  list(
    emms            = read_csv(file.path(base_path, "emms.csv")),
    letters         = read_csv(file.path(base_path, "posthoc_letters.csv")),
    model_summary   = read_csv(file.path(base_path, "model_summary.csv")),
    model_contrasts = read_csv(file.path(base_path, "posthoc_contrasts.csv"))
  )
}

# ============================================================
#                 FIGURE 2 DATA
# ============================================================

# Pika
pika_data            <- load_csv("data/processed/diet_selection/pika_feeding.csv")
pika_feeding_models  <- load_model_data("data/processed/diet_selection/modeled_data/pika_feeding")

# Yak
yak_data             <- load_csv("data/processed/diet_selection/yak_grazing.csv")
yak_feeding_models   <- load_model_data("data/processed/diet_selection/modeled_data/yak_grazing")

# Shared dung/burrow
dung_burrow_by_plot  <- load_csv("data/processed/diet_selection/dung_burrow_by_plot.csv") |>
  mutate(plot = factor(plot))

# ============================================================
#                 FIGURE 3 DATA
# ============================================================

# Weight gain
weight_gain <- load_csv("data/processed/experiment_foraging_efficiency/yak_weight_gain.csv") |>
  mutate(yak = gsub("_[^_]*$", "", yak))
weight_gain_models <- load_model_data("data/processed/experiment_foraging_efficiency/modeled_data/weight_gain")

# Forage quality (all metrics in one pass)
quality_metrics <- c("cp", "adf", "ndf")
forage_quality  <- load_csv("data/processed/experiment_foraging_quality/plant_foraging_quality.csv")
forage_quality_models <- map(quality_metrics,
                             ~ load_model_data("data/processed/experiment_foraging_quality/modeled_data", .x)) |>
  set_names(quality_metrics)

# Plant cover
cover_data     <- load_csv("data/processed/experiment_plant_cover/plant_cover_by_treatment.csv")
grasses_models <- load_model_data("data/processed/experiment_plant_cover/modeled_data/grasses_cover")
poison_models  <- load_model_data("data/processed/experiment_plant_cover/modeled_data/s_chamaejasme_cover")
forbs_models   <- load_model_data("data/processed/experiment_plant_cover/modeled_data/forbs_cover")
sedges_models  <- load_model_data("data/processed/experiment_plant_cover/modeled_data/sedges_cover")

# Flip grouping for sedges posthoc letters
sedges_models$letters <- sedges_models$letters |>
  mutate(.group = ifelse(.group == "a", "b", "a"))

# Active burrow count by treatment
act_burrow_count_dat <- read_csv(here('data/processed/additional_data/modeled_data/active_burrow_dat.csv'),show_col_types=FALSE)
burrow_count_models  <- load_model_data("data/processed/additional_data/modeled_data/active_burrow_count")
weight_gain_burrow_regression_models  <- load_model_data("data/processed/additional_data/modeled_data/weight_gain")


#weight by burrow count
weight_burrow_raw <- read_csv(here('data/processed/additional_data/modeled_data/weight_gain_raw.csv'),show_col_types=FALSE)
weight_burrow_modeled <- read_csv(here('data/processed/additional_data/modeled_data/weight_gain_modeled_dat.csv'),show_col_types=FALSE)

# ============================================================
#                 FIGURE 4 DATA
# ============================================================

# Plant bites
plant_bites <- load_csv("data/processed/experiment_foraging_efficiency/yak_plant_bites.csv") |>
  mutate(plant = gsub("_[^_]*$", "", plant))
plant_groups <- c("forbs", "grasses", "sedges")
plant_bites_models <- map(plant_groups,
                          ~ load_model_data("data/processed/experiment_foraging_efficiency/modeled_data/plant_bites",
                                            paste0(.x, "_plant_bites"))) |>
  set_names(plant_groups)

# Bite/steps
bite_steps <- load_csv("data/processed/experiment_foraging_efficiency/yak_bite_steps_ratio.csv")
bite_step_groups <- c("forbs", "grasses", "sedges")
bite_step_models <- map(bite_step_groups,
                        ~ load_model_data("data/processed/experiment_foraging_efficiency/modeled_data/bite_steps",
                                          paste0(.x, "_bite_steps"))) |>
  set_names(bite_step_groups)

# ============================================================
#            SUPPLEMENTARY FIGURES/TABLES DATA
# ============================================================

# Plant cover
forbs_models   <- load_model_data("data/processed/experiment_plant_cover/modeled_data/forbs_cover")
sedges_models  <- load_model_data("data/processed/experiment_plant_cover/modeled_data/sedges_cover")

# Forage quality
ndf_models     <- load_model_data("data/processed/experiment_foraging_quality/modeled_data/ndf")

# Yak grazing
yak_feeding_model_summary <- yak_feeding_models$model_summary
yak_feeding_contrasts     <- yak_feeding_models$model_contrasts

```

::: {#fig-hypothesis}
```{r fig-hypothesis}
#| echo: false
#| results: asis
#| message: false
#| warning: false
#| fig-width: 11
#| fig-height: 8

library(cowplot)
library(magick)

hypoth_pic <- png::readPNG(here('data/photos/hypothesis_figure.png'))
hypoth_pic <- ggdraw() + draw_image(hypoth_pic) + theme_void(base_size = base_size)

hypoth_pic


```

The hypothesized facilitative effects of pika on yak in the Tibetan Plateau. In the absence of pika, the poisonous Stellera chamaejasme forbs should exert a strong negative effect on yak growth performance by competing with the palatable grasses and sedges, decreasing their food availability and foraging efficiency (Fig. 1a). However, such negative effects of poisonous plants should be mitigated in the presence of pika, whom eliminate S. chamaejasme forbs by their feeding and clipping activities, leading to a facilitative effect on yak (Fig. 1b). The negative effects of poisonous plants on yak were indicated as black dashed lines, the competition between plant groups were indicated by the black solid lines, and the pathway that pika suppress poisonous plants was indicated by red solid line. The sizes of the lines indicate the strengths of species interactions. Credits: Xiaona Zheng (photographs).
:::

# Methods

## Statistical analyses

All data were analyzed using linear models, generalized linear mixed models, or generalized additive models, with the choice of model and statistical family guided by the structure and distribution of the data. Posthoc comparisons were conducted only when the pika × S. chamaejasme interaction term was significant. For the 2021 field surveys, we fit generalized linear mixed models with plot and month as random effects. We then used generalized additive mixed models for S. chamaejasme cover and active pika burrow density, with plot as a random effect, and linear regression models for dung density and S. chamaejasme cover. For the field manipulation experiments in 2022 and 2023, we constructed generalized linear mixed models with the dependent variables (e.g., grass bites per step, sedge bites, weight gain) regressed against the interactive effect of pika and S. chamaejasme treatments, while including block, year, and month as random effects to capture the hierarchical structure of the data. Models assumed gaussian, beta (for proportions), or tweedie (for non-normal data) distributions, selected based on data type and model fit. A significance threshold of P = 0.05 was applied, with TukeyHSD or Sidak posthoc tests used where appropriate. All data management, modeling, and visualization were carried out in R, with dependencies managed using *renv*. The main modeling packages were *glmmTMB* and *mgcv*, with *DHARMa* used for model diagnostics. Data management relied on the *tidyverse* suite of packages. A complete record of package versions is available in the renv.lock file in the repository: <https://github.com/ddlawton/pika_yak_interactions>.

# Results and Discussion

First, we carried out a set of field observational experiments to investigate diet selection by pika and yak, as well as the associations among pika abundance, S. chamaejasme abundance, and yak activity under natural field conditions. Consistent with previous studies^5,11,24–25^, we found that pika and yak have distinct diet preferences: yaks preferred grasses and sedges, while pika preferred the poisonous S. chamaejasme (@fig-diet-selection A,B, @supptbl-pika-yak-feeding-model-summary, @supptbl-pika-yak-feeding-model-contrast). We also found that S. chamaejasme abundance was negatively associated with active pika burrow abundance (@fig-diet-selection C) and with yak foraging activity, as indicated by dung density (@fig-diet-selection D).

Building on these results, we conducted an in-situ manipulative field experiment using fenced enclosures to test the interactive effects of pika and S. chamaejasme on yak weight gain, foraging quantity and quality, and grazing behavior. For weight gain, yaks gained less in poison-plant plots than in non-poison plots, and there was a significant interaction between pika and S. chamaejasme treatments (@supptbl-yak-performance-model-summary). When pika were present, yaks showed higher weight gain (@supptbl-yak-performance-model-contrast). This effect was driven by pika feeding on S. chamaejasme (@fig-diet-selection B, @supptbl-yak-performance-model-summary, @supptbl-yak-performance-model-contrast), which increased grass cover (@fig-diet-selection C, @supptbl-yak-performance-model-summary, @supptbl-yak-performance-model-contrast) compared to plots with S. chamaejasme but no pika.

```{r}
#| label: forage-qaulity
#| echo: false
#| results: hide
#| message: false
#| warning: false

# Function to calculate % increase from "no pika" to "pika"
calc_pct_increase <- function(emms_df, value_col = "response") {
  emms_df |>
    filter(posion_plant_treatment == "S. chamaejasme") |>
    summarise(
      pct_increase = round(
        ( .data[[value_col]][pika_treatment == "pika"] -
          .data[[value_col]][pika_treatment == "no pika"]) /
          .data[[value_col]][pika_treatment == "no pika"] * 100
      )
    ) |>
    pull()
}

cp_increase <- calc_pct_increase(forage_quality_models$cp$emms)
adf_increase <- calc_pct_increase(forage_quality_models$adf$emms)


```

Food quantity and quality are key drivers of individual performance and population dynamics in large herbivores^30–32^. In the presence of *S. chamaejasme* forbs, pika doubled the cover of yak’s most preferred grasses (@fig-diet-selection C, @supptbl-yak-performance-model-summary, @supptbl-yak-performance-model-contrast) and increased the crude protein content by approximately `r {cp_increase}`% (@fig-yak-performance D, @supptbl-yak-performance-model-summary, @supptbl-yak-performance-model-contrast), suggesting that pika facilitate yak by enhancing both the quantity and quality of forage. Acid detergent fibre (`r {adf_increase}`%) was higher in pika plots. These increases in grass abundance and forage quality were likely driven by the decline in poisonous plants induced by pika (@fig-yak-performance B), which reduced interspecific competition for shared resources (e.g., light, soil moisture, nutrients) and allowed grasses to expand^27–28^. In the absence of S. chamaejasme forbs, however, the positive effects of pika on food resources and yak weight gain disappeared (@fig-yak-performance A,C,D). The relationships between active burrow count and treatments, as well as between yak weight gain and burrow density, are presented in @fig-yak-performance (panels G and H) and in @supptbl-pika-burrow-count and @supptbl-weight-gain-burrow-regression, respectively.

```{r}
#| label: bite-increase
#| echo: false
#| warning: false
#| message: false
#| results: "hide"


sedge_bite_increase <- calc_pct_increase(plant_bites_models$sedges$emm,value_col = 'response')
grass_bite_steps <- calc_pct_increase(plant_bites_models$grasses$emm,value_col = 'emmean')
sedge_bite_steps <- calc_pct_increase(plant_bites_models$sedges$emm,value_col = 'response')
  
```

Pika-yak facilitation was also linked to improved foraging efficiency in yak when grazing alongside pika. Optimal foraging theory predicts that animals minimize energy costs to exploit high-quality food items and maximize intake of digestible nutrients, thereby improving performance^33^. In ruminants, bite rate, step rate, and bites per step are key predictors of foraging efficiency^34^ and, ultimately, animal performance^35^. In the presence of *S. chamaejasme* forbs, yak sedge, and grass bite rates increased by roughly `r {sedge_bite_increase}`% (@fig-yak-foraging-efficiency B), and `r {grass_bite_steps}`% (@fig-yak-foraging-efficiency C), respectively, in the treatment where they coexisted with pika (@supptbl-yak-foraging-efficiency-summary, @supptbl-yak-foraging-efficiency-contrast). Yak stepped more often in the presence of *S. chamaejasme* forbs without pika, which meant they consumed more grasses and sedges per step in plots where pika were present.

Sedge bites per step and grass bites per step increased significantly by `r {sedge_bite_steps}`% (@fig-yak-foraging-efficiency E) and `r {grass_bite_steps}`% (@fig-yak-performance F) in plots with pika. These gains in foraging efficiency can be attributed to the decline in *S. chamaejasme* forbs (@fig-yak-performance B), which improved access to palatable grasses and sedges. In this system, increased food availability (@fig-yak-performance C,D) and enhanced foraging efficiency (@fig-yak-performance) likely work together to shape the facilitative effects of pika on yak performance (@fig-yak-performance A).

::: {#fig-diet-selection}
```{r fig-diet-selection}
#| echo: false
#| results: asis
#| message: false
#| warning: false
#| fig-width: 13
#| fig-height: 12
# -------------------------------------------------------------------
# 1. Helper Plot Function
# -------------------------------------------------------------------

library(cowplot)

# Create a feeding/grazing plot (shared structure for pika & yak)
make_feeding_plot <- function(raw_data, emms, letters, yvar, ylabel, 
                              x_order = NULL, box_color = "white", point_color = "black") {
  data <- raw_data |>
    mutate(plant_group = if (!is.null(x_order)) factor(plant_group, levels = x_order) else plant_group)

  ggplot(data, aes(x = plant_group, y = .data[[yvar]])) +
    geom_boxplot(aes(fill = plant_group), color = "black", fill = box_color, alpha = 0.7,linewidth = 1.25) +
    #geom_jitter(width = 0.2, height = 0, color = point_color, alpha = 0.7) +
    geom_text(data = letters, aes(label = .group, y = max(data[[yvar]], na.rm = TRUE) * 1.05), size = geom_text_size) +
    theme_pubr(base_size = base_size) +
    labs(x = NULL, y = ylabel) +
    guides(fill = "none")
}

# -------------------------------------------------------------------
# 2. Models
# -------------------------------------------------------------------

# GAM for S. chamaejasme cover vs pika burrow density
burrow_model <- gam(
  s_chamaejasme_cover_percent ~ 
    s(active_pika_burrow_no_100m2, k = 8, bs = "ts") +
    s(plot, bs = "re"),
  data = dung_burrow_by_plot,
  family = gaussian(),
  select = TRUE
)

# Extract GAM smooth estimates
gam_ests <- smooth_estimates(burrow_model) |>
  mutate(adj_est = .estimate + coef(burrow_model)[1])

# Simple GAM/LM for dung vs cover
dung_model <- gam(yak_dung_no_100m2 ~ s_chamaejasme_cover_percent, data = dung_burrow_by_plot)

# -------------------------------------------------------------------
# 3. Plots
# -------------------------------------------------------------------

# Feeding/clipping plot (pika)
pika_feeding_plot <- make_feeding_plot(
  raw_data = pika_data,
  emms     = pika_feeding_models$emms,
  letters  = pika_feeding_models$letters,
  yvar     = "feeding_clipping_freq",
  ylabel   = "Feeding/clipping frequency (%)",
  x_order  = c("Grasses","Sedges","Forbs","S. chamaejasme")
)

# Grazing plot (yak)

# Reverse .group letters for yak_feeding_models$letters: Grasses = a, Sedges = b, Forbs = c
yak_feeding_models$letters <- yak_feeding_models$letters |> 
  mutate(.group = case_when(
    plant_group == "Grasses" ~ "a",
    plant_group == "Sedges" ~ "b",
    plant_group == "Forbs" ~ "c",
    TRUE ~ .group
  ))

yak_grazing_plot <- make_feeding_plot(
  raw_data = yak_data,
  emms     = (yak_feeding_models$emms |>
    bind_rows(tibble(
      plant_group = "S. chamaejasme",
      emmean      = 0,
      SE          = 0,
      df          = 0,
      lower.CL    = 0,
      upper.CL    = 0
    ))),
  letters  = yak_feeding_models$letters,
  yvar     = "grazing_freq",
  ylabel   = "Grazing frequency (%)",
  x_order  = c("Grasses","Sedges","Forbs","S. chamaejasme")
) +
  scale_x_discrete(drop = FALSE)

# Burrow density vs S. chamaejasme cover
pika_burrow <- ggplot(dung_burrow_by_plot, aes(x = active_pika_burrow_no_100m2, y = s_chamaejasme_cover_percent)) +
  geom_point(color = "darkgrey") +
  geom_ribbon(data = gam_ests,
              aes(x = active_pika_burrow_no_100m2, ymin = adj_est - .se, ymax = adj_est + .se),
              alpha = 0.2, inherit.aes = FALSE) +
  geom_line(data = gam_ests,
            aes(x = active_pika_burrow_no_100m2, y = adj_est),
            color = "blue", linewidth = 1.25) +
  theme_pubr(base_size = base_size) +
  labs(x = expression("Active pika burrow density (no/100 m"^2*")"),
       y = expression(italic("S. chamaejasme")~"cover (%)"))

# Dung density vs cover
dung_plot <- ggplot(dung_burrow_by_plot, aes(x = s_chamaejasme_cover_percent, y = yak_dung_no_100m2)) +
  geom_point(color = "darkgrey") +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  theme_pubr(base_size = base_size) +
  labs(x = expression(italic("S. chamaejasme")~"cover (%)"),
       y = "Yak dung density (no/100 m^2)") +
  coord_cartesian(xlim = c(0, 35), ylim = c(0, 25))

# adding picture of yak
yak_pic <-  png::readPNG(here('data/photos/diet_selection_photo.png'), native = TRUE)
yak_pic <- ggdraw() + draw_image(yak_pic,scale=1) + theme_void(base_size = base_size)



# Combine into Figure 2
layout <- "
AB
AB
DE
DE
"


figure_2_plot <- pika_feeding_plot + 
  yak_grazing_plot +
  pika_burrow + 
  dung_plot + 
  plot_annotation(tag_levels = "A") +
  plot_layout(design = layout, guides = "collect") &
  theme(legend.position = "bottom")

# -------------------------------------------------------------------
# 4. plot Output
# -------------------------------------------------------------------

figure_2_plot

```

Diet selection of pikas and yaks and their potential interactions
mediated by poisonous plants based on field surveys in July 2021. (A) Feeding
and clipping frequencies of pikas, and (B) grazing frequencies of yaks on grasses,
sedges, forbs, and Stellera chamaejasme across 10 2 × 2 m plots and 10 250 m
transects, respectively. (C) Relationship between active pika burrow density and S.
chamaejasme cover, and (D) between S. chamaejasme cover and an index of yak
grazing activity (dung density) in 30 10 × 10 m plots. (E) Photographs showing (left
to right) a pika at its burrow entrance, flowering S. chamaejasme, and a yak grazing
among S. chamaejasme plants. Different letters above bars indicate significant
differences at P &lt; 0.05. Credits: Xiaona Zheng (photographs).
:::

::: {#fig-yak-performance}
```{r}
#| echo: false
#| results: asis
#| message: false
#| warning: false
#| fig-width: 10
#| fig-height: 12

# Helper to check if interaction is significant
interaction_significant <- function(model_summary, interaction_pattern = "pika.*:.*chamaejasme", alpha = 0.05) {
  # Find the interaction row (term contains both pika and chamaejasme)
  row <- model_summary[grepl(interaction_pattern, model_summary$term), ]
  if (nrow(row) == 0) return(FALSE)
  # Use p.value or p.value column (could be named differently)
  pval_col <- intersect(c("p.value", "pvalue", "p_val", "p.val"), names(row))
  if (length(pval_col) == 0) return(FALSE)
  return(any(row[[pval_col[1]]] < alpha, na.rm = TRUE))
}

# Generic plot for treatment × response with jitter, means, and letters
make_treatment_plot <- function(data, emms, letters, response_var, y_label, label_y = NULL, model_summary = NULL) {
  if ("response" %in% names(emms)) {
    emms <- emms |> mutate(.mean_val = response * 100)
  } else if ("emmean" %in% names(emms)) {
    emms <- emms |> mutate(.mean_val = emmean)
  } else {
    stop("emms must contain either 'response' or 'emmean' column")
  }
  label_y <- label_y %||% max(data[[response_var]], na.rm = TRUE)
  # Only show letters if interaction is significant
  show_letters <- TRUE
  if (!is.null(model_summary)) {
    show_letters <- interaction_significant(model_summary)
  }
  p <- ggplot(data, aes(x = pika_treatment, y = .data[[response_var]], fill = posion_plant_treatment)) +
    geom_boxplot(position = position_dodge(width = 1), color = "black", outlier.shape = NA) +
    scale_fill_manual(values = plant_colors) +
    scale_color_manual(values = plant_colors) +
    labs(x = NULL, y = y_label, color = NULL, fill = NULL) +
    theme_pubr(base_size = base_size) +
    theme(legend.position = "bottom")
  if (!is.null(letters) && show_letters) {
    p <- p +
      geom_text(
        data = letters,
        aes(x = pika_treatment, y = label_y, label = .group, group = posion_plant_treatment),
        position = position_dodge(width = 1),
        size = geom_text_size, color = "black", show.legend = FALSE
      )
  }
  p
}


# Update letter groupings
weight_gain_models$letters <- weight_gain_models$letters |> mutate(.group = ifelse(.group == 'a','b','a'))
grasses_models$letters <- grasses_models$letters |> mutate(.group = ifelse(.group == 'a','b','a'))
forage_quality_models$cp$letters <- forage_quality_models$cp$letters |> mutate(.group = ifelse(.group == 'a','b','a'))
forage_quality_models$adf$letters <- forage_quality_models$adf$letters |> mutate(.group = ifelse(.group == 'a','b','a'))

# Panels (letters only if interaction significant)
panel_a <- make_treatment_plot(
  data    = weight_gain,
  emms    = weight_gain_models$emms,
  letters = weight_gain_models$letters,
  response_var = "weight_gain",
  y_label = "Weight gain (kg/yak/day)",
  label_y = 0.60,
  model_summary = weight_gain_models$model_summary
)

panel_b <- make_treatment_plot(
  data    = cover_data |> filter(plant == "s_chamaejasme"),
  emms    = poison_models$emms,
  letters = poison_models$letters,
  response_var = "cover",
  y_label = expression(italic("S. chamaejasme") ~ "cover (%)"),
  label_y = 43,
  model_summary = poison_models$model_summary
)

panel_c <- make_treatment_plot(
  data    = cover_data |> filter(plant == "grasses"),
  emms    = grasses_models$emms,
  letters = grasses_models$letters,
  response_var = "cover",
  y_label = "Grass cover (%)",
  label_y = 41,
  model_summary = grasses_models$model_summary
)

panel_d <- make_treatment_plot(
  data    = forage_quality |> filter(plant == "cp"),
  emms    = forage_quality_models$cp$emms,
  letters = forage_quality_models$cp$letters,
  response_var = "forage_quality",
  y_label = "CP (%)",
  label_y = 10,
  model_summary = forage_quality_models$cp$model_summary
)

panel_e <- make_treatment_plot(
  data    = forage_quality |> filter(plant == "adf"),
  emms    = forage_quality_models$adf$emms,
  letters = forage_quality_models$adf$letters,
  response_var = "forage_quality",
  y_label = "ADF (%)",
  label_y = 36,
  model_summary = forage_quality_models$adf$model_summary
)

sedge_plot <- make_treatment_plot(
  data    = cover_data |> filter(plant == "sedges"),
  emms    = sedges_models$emms,
  letters = sedges_models$letters,
  response_var = "cover",
  y_label = "Sedge cover (%)",
  label_y = 70,
  model_summary = sedges_models$model_summary
)

ndf_plot <- make_treatment_plot(
  data    = forage_quality |> filter(plant == "ndf"),
  emms    = forage_quality_models$ndf$emms,
  letters = NULL,#forage_quality_models$ndf$letters,
  response_var = "forage_quality",
  y_label = "NDF (%)",
  label_y = 70
)

panel_g <- ggplot(act_burrow_count_dat, aes(x = pika_treatment, y = active_burrows, color = posion_plant_treatment)) +
  geom_boxplot(aes(fill = posion_plant_treatment), position = position_dodge(width = 1), color = "black", outlier.shape = NA) +
  scale_fill_manual(values = plant_colors) +
  scale_color_manual(values = plant_colors) +
  labs(x = NULL, y = 'No. active burrows/ha', color = NULL, fill = NULL) +
  theme_pubr(base_size = base_size) +
  theme(legend.position = "bottom")

panel_h <- weight_burrow_modeled |>
  ggplot(aes(x = active_burrows, y = adj_est)) +
  geom_point(data = weight_burrow_raw, aes(y = weight_gain_mean), color = plant_colors[2]) +
  geom_line(aes(y = adj_est), size = 1) +
  theme_pubr() +
  xlab('No. active burrows/ha') +
  ylab('Weight gain kg/yak/day') +
  xlim(0, 500) +
  ylim(0, 0.5)

# 3x3 layout
layout <- "
ABC
DEF
GHI
"

figure_3 <- panel_g + panel_a + panel_h +
            panel_b + panel_c + sedge_plot +
            panel_d + panel_e + plot_spacer() +
            plot_annotation(tag_levels = "A") +
            plot_layout(design = layout, guides = "collect") & theme(legend.position = "bottom")

figure_3

```

Combined effects of two-year (2022–2023) pika and Stellera
chamaejasme removal treatments on yak growth, forage quantity, and quality in
the field manipulative experiment. (A) Pika density (indicated by active burrow
density), (B) yak weight gain, (C) relationship between pika density and yak weight
gain, (D) S. chamaejasme cover, (E) grass cover, (F) sedge cover, (G) crude protein
(CP) content, and (H) acid detergent fibre (ADF) content. Average values from both years were used in
analyses, yielding one data point per 150 × 150 m plot. Significant interactions
between pikas and S. chamaejasme were evaluated using post hoc tests; means not
sharing letters differ significantly. For panels A and F, only main effects were
significant (Table S3). Error bars indicate +/- SE.
:::

::: {#fig-yak-foraging-efficiency}
```{r fig-yak-foraging-efficiency}
#| echo: false
#| results: asis
#| message: false
#| warning: false
#| fig-width: 10
#| fig-height: 8


# ============================================================
#                 PLANT BITE DATA
# ============================================================


# Adjust letter groupings consistently
plant_bites_models <- map(plant_bites_models, function(x) {
  x$letters <- x$letters |> mutate(.group = ifelse(.group == "a", "b", "a"))
  x
})

# ============================================================
#                 BITE/STEPS DATA
# ============================================================

# Adjust letter groupings consistently
bite_step_models <- map(bite_step_models, function(x) {
  x$letters <- x$letters |>
    mutate(.group = ifelse(.group %in% c("a", "A"), "b", "a"))
  x
})

# ============================================================
#                 REUSABLE PLOTTING FUNCTIONS
# ============================================================
# --- Plant Bites Plot (panels A–C) ---
plot_plant_bites <- function(plant_name, y_label, label_y = NULL, letters = TRUE) {
  data <- plant_bites |> filter(plant == plant_name)
  model <- plant_bites_models[[plant_name]]
  # Standardize emms table
  emms <- model$emms
  if ("response" %in% names(emms)) {
    emms <- emms |> mutate(.mean_val = response * 100)
  } else if ("emmean" %in% names(emms)) {
    emms <- emms |> mutate(.mean_val = emmean)
  } else {
    stop("model$emms must contain either 'response' or 'emmean'")
  }
  # Standardize letters table
  letters_df <- model$letters
  if ("response" %in% names(letters_df)) {
    letters_df <- letters_df |> mutate(.mean_val = response)
  } else if ("emmean" %in% names(letters_df)) {
    letters_df <- letters_df |> mutate(.mean_val = emmean)
  } else {
    stop("model$letters must contain either 'response' or 'emmean'")
  }
  # Set default y-position for labels if not supplied
  label_y <- label_y %||% (max(data$forage_efficiency, na.rm = TRUE) + 0.05)
  # Only show letters if interaction is significant
  show_letters <- TRUE
  if (!is.null(model$model_summary)) {
    show_letters <- interaction_significant(model$model_summary)
  }
  p <- ggplot(data, aes(x = pika_treatment, y = forage_efficiency, fill = posion_plant_treatment)) +
    geom_boxplot(position = position_dodge(width = 1), color = "black", outlier.shape = NA) +
    scale_fill_manual(values = plant_colors) +
    labs(
      y = y_label, x = "",
      fill = "Poison plant treatment"
    ) +
    theme_pubr(base_size = base_size) +
    theme(legend.position = "bottom", legend.title = element_blank())
  if (letters && show_letters) {
    p <- p +
      geom_text(
        data = letters_df,
        aes(x = pika_treatment, y = label_y, label = .group, group = posion_plant_treatment),
        position = position_dodge(width = 1),
        size = geom_text_size, color = "black", show.legend = FALSE, inherit.aes = FALSE
      )
  }
  p
}

# --- Bite/Step Ratio Plot (panels E and F) ---
plot_bite_steps <- function(plant_name, y_label, label_y = NULL, add_letters = TRUE) {
  data <- bite_steps |> filter(plant == plant_name)
  model <- bite_step_models[[plant_name]]
  label_y <- label_y %||% max(data$bites_steps_ratio, na.rm = TRUE) + 0.05
  # Only show letters if interaction is significant
  show_letters <- TRUE
  if (!is.null(model$model_summary)) {
    show_letters <- interaction_significant(model$model_summary)
  }
  p <- ggplot(data, aes(x = pika_treatment, y = bites_steps_ratio, fill = posion_plant_treatment)) +
    geom_boxplot(position = position_dodge(width = 1), color = "black", outlier.shape = NA) +
    scale_fill_manual(values = plant_colors) +
    labs(y = y_label, x = "", fill = "Poison plant treatment") +
    theme_pubr(base_size = base_size) +
    theme(legend.position = "bottom", legend.title = element_blank())
  if (add_letters && show_letters) {
    p <- p + geom_text(data = model$letters,
                       aes(x = pika_treatment, y = label_y, label = .group, group = posion_plant_treatment),
                       position = position_dodge(width = 1),
                       size = geom_text_size, color = "black", show.legend = FALSE)
  }
  p
}


# ============================================================
#                 COMBINE PANELS
# ============================================================

# Generate bite panels
panel_a <- plot_plant_bites("sedges", "Sedge bites", label_y = 450)
panel_b <- plot_plant_bites("grasses", "Grass bites", label_y = 350)

# Generate bite/step panels
panel_c <- plot_bite_steps("sedges", "Sedge bite/step", label_y = 1)
panel_d <- plot_bite_steps("grasses", "Grass bite/step")

# Layout specification
layout <- "
AB
CD
"

figure_4 <- panel_a + panel_b + panel_c +
            panel_d +
            plot_annotation(tag_levels = "A") +
            plot_layout(design = layout, guides = "collect") &
            theme(legend.position = "bottom")

figure_4

```

Combined effects of two-year (2022–2023) pika and Stellera
chamaejasme removal treatments on yak foraging efficiency in the field
manipulative experiment. (A, B) Bite rates and (C, D) bites per step for sedges and
grasses, respectively. Mean values from both years were used for analysis (one data
point per 150 × 150 m plot). Significant interactions between pikas and S.
chamaejasme were evaluated using post hoc tests; means not sharing letters differ
significantly. Error bars indicate +/- SE.
:::

# Supplementary Figures and Tables

::: {#suppfig-ndf-plot}

```{r}
#| echo: false
#| results: 'asis'
#| message: false
#| warning: false
# ndf_plot <- make_treatment_plot(
#   data    = forage_quality |> filter(plant == "ndf"),
#   emms    = forage_quality_models$ndf$emms,
#   letters = NULL,#forage_quality_models$ndf$letters,
#   response_var = "forage_quality",
#   y_label = "NDF (%)",
#   label_y = 70
# )

# ndf_plot

forbs_plot <- make_treatment_plot(
  data    = cover_data |> filter(plant == "forbs"),
  emms    = forbs_models$emms,
  letters = forbs_models$letters,
  response_var = "cover",
  y_label = "Forb cover (%)",
  label_y = 45,
  model_summary = forbs_models$model_summary
)

```

Combined effects of two-year (2022–2023) pika and Stellera
chamaejasme removal on forb cover in the field manipulative experiment. The
average values of each variable in the two years were used for statistical analysis,
providing a single data point for each variable in each 150 × 150 m plot. Error bars
represent +/- SE.
:::


::: {#suppfig-forb-bite-steps}

```{r}
#| echo: false
#| results: 'asis'
#| message: false
#| warning: false

# Generate bite panels
panel_a <- plot_plant_bites("forbs", "Forb bites", label_y = 200,letters=FALSE)

# Generate bite/step panels
panel_b <- plot_bite_steps("forbs", "Forbs bite/steps", label_y = 0.4, add_letters = FALSE)

# Layout specification
layout <- "
AB
"

supp_fig_2 <- panel_a + panel_b + 
            plot_annotation(tag_levels = "A") +
            plot_layout(design = layout, guides = "collect") &
            theme(legend.position = "bottom")

supp_fig_2


```

Combined effects of two-year (2022–2023) pika and Stellera
chamaejasme removal on foraging efficiency of yaks in the field manipulative experiment. (A) bite rates and (B) bites per step of yaks for forbs, respectively. The
average values of each variable in the two years were used for statistical analysis,
providing a single data point for each variable in each 150 × 150 m plot. Error bars
represent +/- SE.
:::



::: {#supptbl-pika-yak-feeding-model-summary}
```{r}
#| echo: false
#| results: 'asis'
#| message: false
#| warning: false


bind_rows(
  pika_feeding_models$model_summary |> mutate(model = "Pika feeding"),
  yak_feeding_models$model_summary  |> mutate(model = "Yak feeding")
) |>
  mutate(term = case_when(str_detect(term,'sd__') ~ group,
    TRUE ~ term),
    effect = ifelse(effect == 'ran_pars','random','fixed'),
    term = gsub('plant_group','',term)) |>
  select(-c(component,group)) |>
  gt(groupname_col = "model") |>
  fmt_number(columns = where(is.numeric), decimals = 2)


```

Model summary for pika and yak feeding.
:::

::: {#supptbl-pika-yak-feeding-model-contrast}
```{r}
#| echo: false
#| results: 'asis'
#| message: false
#| warning: false

bind_rows(
  pika_feeding_models$model_contrasts |> mutate(model = "Pika feeding"),
  yak_feeding_models$model_contrasts  |> mutate(model = "Yak feeding")
) |>
  gt(groupname_col = "model") |>
  fmt_number(columns = where(is.numeric), decimals = 2)


```

Model contrasts for pika and yak feeding.
:::

::: {#supptbl-pika-burrow-count}
```{r}
#| echo: false
#| results: 'asis'
#| message: false
#| warning: false


burrow_count_models$model_summary  |>
  mutate(term = case_when(str_detect(term,'sd__') ~ group,
    TRUE ~ term),
    effect = ifelse(effect == 'ran_pars','random','fixed'),
    term = gsub('plant_group','',term)) |>
  dplyr::select(-c(component,group)) |>
  gt(groupname_col = "model") |>
  fmt_number(columns = where(is.numeric), decimals = 2)

```

Model summary for active burrow count between treatment levels. Estimates are from a generalized linear mixed model with block, year, and month as random effects.
:::

::: {#supptbl-weight-gain-burrow-regression}
```{r}
#| echo: false
#| results: 'asis'
#| message: false
#| warning: false


weight_gain_burrow_regression_models$model_summary  |>
  gt() |>
  fmt_number(columns = where(is.numeric), decimals = 2)

```

Model summary for yak weight gain regressed on active burrow count. Estimates are from a generalized additive mixed model with block, year, and month as random effects.
:::

::: {#supptbl-yak-performance-model-summary}
```{r}
#| echo: false
#| results: 'asis'
#| message: false
#| warning: false

yak_performance_summary_table <- bind_rows(
  weight_gain_models$model_summary |> mutate(model = 'weight gain'),
  grasses_models$model_summary |> mutate(model = 'grass cover'),
  sedges_models$model_summary |> mutate(model = 'sedge cover'),
  forbs_models$model_summary |> mutate(model = 'forb cover'),
  poison_models$model_summary |> mutate(model = 'S. chamaejasme'),
  forage_quality_models$cp$model_summary |> mutate(model = 'crude protein %'),
  forage_quality_models$adf$model_summary |> mutate(model = 'acid detergent fibre %'),
  forage_quality_models$ndf$model_summary |> mutate(model = 'neutral detergent fiber %'))  |>
  mutate(term = case_when(str_detect(term,'sd__') ~ group,
    TRUE ~ term),
    effect = ifelse(effect == 'ran_pars','random','fixed'),
    term = gsub('pika_treatment|posion_plant_treatment','',term)) |>
  select(-c(component,group))

yak_performance_summary_table |>
  gt(groupname_col = "model") |>
  fmt_number(columns = where(is.numeric), decimals = 2)

```

Model summary for weight gain, grass cover, S. chamaejasme cover, crude protein %, acid detergent fibre %.
:::

::: {#supptbl-yak-performance-model-contrast}
```{r}
#| echo: false
#| results: 'asis'
#| message: false
#| warning: false


yak_performance_contrast_table <- bind_rows(
  weight_gain_models$model_contrasts |> mutate(model = 'weight gain'),
  grasses_models$model_contrasts |> mutate(model = 'grass cover'),
  poison_models$model_contrasts |> mutate(model = 'S. chamaejasme'),
  forage_quality_models$cp$model_contrasts |> mutate(model = 'crude protein %'),
  forage_quality_models$adf$model_contrasts |> mutate(model = 'acid detergent fibre %'))  |>
  select(contrast,estimate,SE,df,t.ratio,p.value,model)

yak_performance_contrast_table |>
  gt(groupname_col = "model") |>
  fmt_number(columns = where(is.numeric), decimals = 2)


```

Model contrasts for weight gain, grass cover, S. chamaejasme cover, crude protein %, and acid detergent fibre % of total forage for yaks

:::

::: {#supptbl-yak-foraging-efficiency-summary}
```{r}
#| echo: false
#| results: 'asis'
#| message: false
#| warning: false

yak_foraging_efficiency_table <- bind_rows(
  plant_bites_models$sedges$model_summary |> mutate(model = 'sedge bites/h'),
  plant_bites_models$grasses$model_summary |> mutate(model = 'grass bites/h'),
  plant_bites_models$forbs$model_summary |> mutate(model = 'forb bites/h'),
  bite_step_models$sedges$model_summary |> mutate(model = 'sedges bite steps'),
  bite_step_models$grasses$model_summary |> mutate(model = 'grass bite steps'),
  bite_step_models$forbs$model_summary |> mutate(model = 'forb bite steps')
  )    |>
  mutate(term = case_when(str_detect(term,'sd__') ~ group,
    TRUE ~ term),
    effect = ifelse(effect == 'ran_pars','random','fixed'),
    term = gsub('pika_treatment|posion_plant_treatment','',term)) |>
  select(-c(component,group))

yak_foraging_efficiency_table |>
  gt(groupname_col = "model") |>
  fmt_number(columns = where(is.numeric), decimals = 2)


```

Model summary for plant bites/h and the bites to step ratio for sedges, grasses, and forbs.
:::

::: {#supptbl-yak-foraging-efficiency-contrast}
```{r}
#| echo: false
#| results: 'asis'
#| message: false
#| warning: false

yak_foraging_efficiency_table <- bind_rows(
  plant_bites_models$sedges$model_contrasts |> mutate(model = 'sedge bites/h'),
  plant_bites_models$grasses$model_contrasts |> mutate(model = 'grass bites/h'),
  bite_step_models$sedges$model_contrasts |> mutate(model = 'sedges bite steps'),
  bite_step_models$grasses$model_contrasts |> mutate(model = 'grass bite steps')
  )  |>
  select(contrast,estimate,SE,df,t.ratio,p.value,model)

yak_foraging_efficiency_table |>
  gt(groupname_col = "model") |>
  fmt_number(columns = where(is.numeric), decimals = 2)


```

Model contrasts for plant bites and the bites to step ratio for sedges, grasses, and forbs.
:::