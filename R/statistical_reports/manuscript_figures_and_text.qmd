---
title: "Pika-Yak Interaction: Plant Cover"
author: "Douglas Lawton"
date: today
format:
  html:
    toc: true
    toc-depth: 2
    number-sections: true
    fig-cap-location: bottom
    theme: cosmo
editor: source
crossref:
  custom:
    - kind: float
      key: fig
      latex-env: fig
      reference-prefix: Figure
      space-before-numbering: true
      latex-list-of-description: Figure
    - kind: float
      key: suppfig
      latex-env: suppfig
      reference-prefix: Supplementary Figure 
      space-before-numbering: true
      latex-list-of-description: Supplementary Figure
    - kind: float
      key: tbl
      latex-env: tbl
      reference-prefix: Table
      space-before-numbering: true
      latex-list-of-description: Table
    - kind: float
      key: supptbl
      latex-env: supptbl
      reference-prefix: Supplementary Table
      space-before-numbering: true
      latex-list-of-description: Supplementary Table

---

# Methods

## Statistical analyses

All data were analyzed within with either linear models, generalized linear mixed models, or a generalized additive model. We selected the most appropriate model and statistical family to best reflect the nature of the data. We conducted posthoc comparisons only if the main model term was significant. For field surveys in 2021, we used a generlized linear mixed model with plot and month as random effects. We then conducted a generalized additive mixed model for *S. chamaejasme* cover and active pika burrow density with plot as a random effect and a basic linear regression for dung density and *S. chamaejasme* cover. For the field manipulated experiments in 2022 and 2023, we constructed generalized linear mixed models regressing the dependent variable (e.g. grass bite/steps, sedge total bites, weight gain, etc) against an interactive effect of pika and *S. chamaejasme* treatments and add block, year, and month as random effects to better reflect the hierarchical nature of the data. All models either assumed a gaussian, beta, or tweedie distributions based on model fit. We used a P value of 0.05 and either a tukeyHSD or sidak posthoc comparison when appropriate. All data management, modeling, and visualization was conducted in R and package depencies were managed using renv. The main modeling packages used were glmmTMB and mgcv with the main diagnostic package being DHARMa. All data management was conduct with the tidyverse suite of packages. All packages and versions can be seen in the renv.lock file on the github <https://github.com/ddlawton/pika_yak_interactions>.

# Results and Discussion

We firstly carried out a set of field observational experiments to investigate the diet selections of pika and yak, and the associations among pika abundance, S. chamaejasme abundance, and yak activities under unmanipulated field conditions. Consistent with previous studies^5,11,24-25^, we found that pika and yak have a distinguished diet preferences: yaks preferred grasses and sedge, whereas pika preferred the poisonous *S. chamaejasme* (@fig-2 A,B, @supptbl-pika-feeding-model-summary,@supptbl-pika-feeding-model-contrast,@tbl-yak-feeding-model-summary @supptbl-yak-feeding-model-contrast). Moreover, we found that the *S. chamaejasme* abundance was negatively associated with active pika burrow abundance (@fig-2 C), whereas the S. chamaejasme abundance was negatively associated with yak foraging activities, which indicated by dung density (@fig-2 D).

Given these results, we then conducted an in-situ manipulative field experiment to explicitly examine the interactive effects of pika and *S. chamaejasme* on weight gain, foraging quantity and quality, and grazing behaviors of yak by using fencing enclosure plots. For weight gain, overall yaks had a lower weight gain in poison plant plots than non-poison plant plots and there was an interactive effect between pika and  *S. chamaejasme* treatments (@supptbl-yak-weight-gain-model-summary). When pika were present, yaks had a high weight gain (@supptbl-pika-feeding-model-contrast). This is due to Pika feeding on *S. chamaejasme* (@fig-2 B, @supptbl-poison-cover-summary, @supptbl-poison-cover-contrasts), allow for more grass cover (@fig-2 C, @supptbl-grass-cover-model-summary, @supptbl-grass-cover-contrasts) as compared to the *S. chamaejasme* and no pika treatment plots.








We found an opposing effect of poisonous plants and pika on yak growth performance; *S. chamaejasme* cover significantly reduced while pika presence increased weight gain of yak by 15% (S. chamaejasme, F1,3 =16.36, P = 0.027) and 27% (pika, F1,3 =87.36, P = 0.03), respectively. More importantly, there is an interactive effects between them (F1,3 =11.93, P = 0.041). In the presence of S. chamaejasme forbs, yak significantly increased weight gain by 71% when they shared foraging areas with pika (P < 0.001, Fig.3a). However, such facilitative effects disappeared in the treatments without S. chamaejasme forbs (Fig.3a). These results, in combination with the fact that pika prefer S. chamaejasme forbs (Fig. 2a) and that S. chamaejasme abundance reduced dramatically by 67% in the presence of pika (P < 0.001, Fig. 3b), indicating that pika facilitate yak through suppressing these poisonous plants.


Food quantity and quality are key drivers of individual performance and population dynamics of large herbivores30-32. In the presence of S. chamaejasme forbs, pika increased cover of yak’s most favored grasses by 118% (P = 0.001, Fig. 3c) and increased crude protein content of total forage by 16% (P = 0.002, Fig. 3d), suggesting that pika facilitate yak by increasing the quantity and quality of forage plants. The increases in grass abundance and forage quality were likely driven by the decline in poisonous plant abundance induced by pika (Fig. 3b), which released inter-specific competition for shared resources (e.g., light, soil moisture and nutrients) and allowed their growth and expansion27-28. In the absence of S. chamaejasme forbs, however, the positive effects of pika on food resources and weight gain of yak disappeared (Fig. 3a,c,d). Pika and poisonous plants failed to significantly affected neither sedge cover, forb cover (Fig. S1), nor other chemical properties (e.g., acid detergent fibre, neutral detergent fibre, and ether extract) of forage in the plots (Fig. S2).


Pika-yak facilitation was also associated with enhanced foraging efficiency in yak after shared grazing with pika. Optimal foraging theory predicts that animals tend to use mimumne energy cost to exploit high-quality food items or units to optimise the intake of digestible nutrients and hence animal production33. In ruminants, bite rate, step rate and bites per step predict foraging efficiency34, which are key to determine animal performance35. In the presence of S. chamaejasme forbs, yak's total bites rate and sedge bite rate was 34% (P = 0.001, Fig. 4a) and 58% (P = 0.001, Fig. 4b) higher in the treatment when they co-existed with pika. Moreover, while yak total steps rate was affected by neither pika nor S. chamaejasme (Fig. 4d), sedge bites per step and grass bites per step by yak significantly increased 89% (P < 0.001, Fig. 4e) and 80% (P = 0.001, Fig. 4f) in the plots with pika, respectively. The improved yak foraging efficiency can be attributed to the declines in poisonous S. chamaejasme forbs (Fig. 3b), which enhanced their access to the palatable sedges and grasses in the presence of pika. In our system, the increases in food availability (Fig. 3c,d) and foraging efficiency (Fig. 4) may jointly shape the facilitative effects of pika on yak performance (Fig. 3a).


In the Tibetan Plateau, the consumption of poisonous plants by small mammals such as pika and zokors (Eospalax baileyi) have long been noted24,36, and their detoxification mechanisms have been explored37-38. It is suggested that herbivores have evolved several adaptation strategies to cope with plant secondary metabolites (PSMs) in poisonous plants. For example, converting digested PSMs into non-toxic metabolites, adjusting catabolism processes at the physiological and genetic levels, or modifying gut microbiota to reduce PSM absorption, thus mitigating toxic injury39-41. Indeed, recent evidence suggests that the plateau zokors in the Tibetan Plateau can detoxify the toxic secondary metabolites from S. chamaejasme forbs through 1) P450 pair xenobiotic clearance, bile secretion, and xenobiotic clearance pathway37, and 2) reduce chenodeoxycholic acid and prostaglandin in the liver38. The similar physiological detoxification strategies may also apply to plateau pika in the same ecosystems. 

Collectively, our results illustrate how small mammals can indirectly facilitate co-occurring large herbivores. By quantifying in situ effects of pika on poisonous plants abundance and experimentally manipulating this factor, we show that small mammals can play an important role in driving large herbivore population dynamics. We also demonstrated that diet differentiation is the key driver of such interspecific facilitation between small mammals and large herbivores. Our findings challenge the dominant paradigm that small mammals should purely compete with large herbivores for food4-6,. While intuitively appealing, this historic perspective is overly simplistic when considering the adaptive foraging ability and diet partitioning in herbivore community. 

One paradigm of interspecific facilitation is that it tends to be greater in more stressful environments (i.e., stress gradient hypothesis, SGH)42. This paradigm has been widely documented in plant and microbial community43,44, with also increasing evidence in herbivore community16,17,45. Hence, while our study only looked at pika-yak interactions in summer with enough food resources, whether or not such facilitative effect will be lessened or even shifts to competition under more stressful conditions (e.g., when food resources become limited during winter or as herbivore density increases) deserves further investigations.

Our results suggest that, at least during the growing seasons, maintaining a low to moderate density of rather than extensively eradicate pika, would benefit livestock production in the Tibetan Plateau. As the increase in demands of milk and meat by human globally, livestock continues to encroach into natural or semi-natural habitats46, building a diverse ecological interactions with local small animals, both vertebrates and invertebrates47. A comprehensive investigation the causes and consequences of livestock-small animal interactions can help to better understanding animal species coexistence, and is crucial for livestock production predictions and small animal conservation in grasslands.



```{r}
#| label: gloabl settings
#| echo: false
#| results: "hide"
#| message: false
#| warning: false

library(tidyverse)
library(ggpubr)
library(patchwork)
library(here)
library(mgcv)
library(knitr)
library(kableExtra)
library(gratia)   
library(glue)

# --- Set Root Directory for Project ---
here::i_am("README.md")  # Anchor project for reproducible paths

# --- Custom Color Palette ---
pink <- '#ff8080'
green <- '#2fc09b'


plant_colors <- c(green, pink)
```

```{r}
#| label: fig-2
#| fig-cap: "Diet selection of pika and yak and their potential interactions mediated by poisonous plants in the field surveys in July 2021. (a) Feeding and clipping frequency of pika, and (b) grazing frequency of yak on the S. chamaejasme, sedges, grasses, and forbs in the 10 2 m × 2 m plots and the 10 250 m transects, respectively. (c) The relationship between active pika burrow density and S. chamaejasme cover, and (d) the relationship between S. chamaejasme cover and yak grazing activity in the 30 10 m × 10 m plots. (e) Two yak were grazing around the poisonous S. chamaejasme during its flowering season (i.e., May to June) in the study site. Different letters above the bars indicate significant differences at P < 0.05."
#| echo: false
#| reulsts: asis'
#| message: false
#| warning: false
#| fig-width: 10
#| fig-height: 8

# -------------------------------------------------------------------
# 1. Helper Functions
# -------------------------------------------------------------------

# Load a CSV relative to project root
load_csv <- function(...) {
  read_csv(here(...), show_col_types = FALSE)
}

# Create a feeding/grazing plot (shared structure for pika & yak)
make_feeding_plot <- function(raw_data, emms, letters, yvar, ylabel, 
                              x_order = NULL, jitter_color = "darkgrey", point_color = "blue") {
  data <- raw_data |>
    left_join(emms, by = "plant_group") |>
    mutate(plant_group = if (!is.null(x_order)) factor(plant_group, levels = x_order) else plant_group)
  
  ggplot(data, aes(x = reorder(plant_group,emmean), y = .data[[yvar]])) +
    geom_jitter(width = 0.2, height = 0, color = jitter_color) +
    geom_point(aes(y = emmean), size = 5, color = point_color) +
    geom_text(data = letters, aes(label = .group, y = 105)) +
    theme_pubr() +
    labs(x = NULL, y = ylabel)
}

# -------------------------------------------------------------------
# 2. Load Data
# -------------------------------------------------------------------

# Pika
pika_data              <- load_csv("data/processed/diet_selection/pika_feeding.csv")
pika_feeding_emms      <- load_csv("data/processed/diet_selection/modeled_data/pika_feeding/emms.csv")
pika_feeding_letters   <- load_csv("data/processed/diet_selection/modeled_data/pika_feeding/posthoc_letters.csv")

# Yak
yak_data               <- load_csv("data/processed/diet_selection/yak_grazing.csv")
yak_feeding_emms       <- load_csv("data/processed/diet_selection/modeled_data/yak_grazing/emms.csv")
yak_feeding_letters    <- load_csv("data/processed/diet_selection/modeled_data/yak_grazing/posthoc_letters.csv")

# Shared dung/burrow data
dung_burrow_by_plot    <- load_csv("data/processed/diet_selection/dung_burrow_by_plot.csv") |>
  mutate(plot = factor(plot))

# -------------------------------------------------------------------
# 3. Models
# -------------------------------------------------------------------

# GAM for S. chamaejasme cover vs pika burrow density
burrow_model <- gam(
  s_chamaejasme_cover_percent ~ 
    s(active_pika_burrow_no_100m2, k = 8, bs = "ts") +
    s(plot, bs = "re"),
  data = dung_burrow_by_plot,
  family = gaussian(),
  select = TRUE
)

# Extract GAM smooth estimates
gam_ests <- smooth_estimates(burrow_model) |>
  mutate(adj_est = .estimate + coef(burrow_model)[1])

dung_model <- gam(yak_dung_no_100m2 ~ s_chamaejasme_cover_percent, data=dung_burrow_by_plot)

# -------------------------------------------------------------------
# 4. Plots
# -------------------------------------------------------------------

# Feeding/grazing plots
pika_feeding_plot <- make_feeding_plot(
  raw_data = pika_data,
  emms = pika_feeding_emms,
  letters = pika_feeding_letters,
  yvar = "feeding_clipping_freq",
  ylabel = "Feeding/clipping frequency (%)"
)

yak_grazing_plot <- make_feeding_plot(
  raw_data = yak_data,
  emms = (yak_feeding_emms |>
  bind_rows(tibble(
    plant_group = "S. chamaejasme",
    emmean      = 0,
    SE          = 0,
    df          = 0,
    lower.CL    = 0,
    upper.CL    = 0
  ))),
  letters = yak_feeding_letters,
  yvar = "grazing_freq",
  ylabel = "Grazing frequency (%)",
  x_order = c("S. chamaejasme", "Forbs", "Sedges", "Grasses")
) +
  scale_x_discrete(drop = FALSE)

# Burrow vs S. chamaejasme plot
pika_burrow <- ggplot(dung_burrow_by_plot, aes(x = active_pika_burrow_no_100m2, y = s_chamaejasme_cover_percent)) +
  geom_point(color = "darkgrey") +
  geom_ribbon(data = gam_ests,
              aes(x = active_pika_burrow_no_100m2, ymin = adj_est - .se, ymax = adj_est + .se),
              alpha = 0.2, inherit.aes = FALSE) +
  geom_line(data = gam_ests,
            aes(x = active_pika_burrow_no_100m2, y = adj_est),
            color = "blue", linewidth = 1.25) +
  theme_pubr() +
  labs(x = expression("Active pika burrow density (no/100 m"^2*")"),
       y = expression(italic("S. chamaejasme")~"cover (%)"))

# Dung density vs cover plot
dung_plot <- ggplot(dung_burrow_by_plot, aes(x = s_chamaejasme_cover_percent, y = yak_dung_no_100m2)) +
  geom_point(color = "darkgrey") +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  theme_pubr() +
  labs(x = expression(italic("S. chamaejasme")~"cover (%)"),
       y = "Yak dung density (no/100 m^2)") +
  coord_cartesian(xlim = c(0, 35), ylim = c(0, 25))

# Combine into Figure 2
figure_2_plot <- (pika_feeding_plot + yak_grazing_plot) / 
                 (pika_burrow + dung_plot) +
  plot_annotation(tag_levels = "A") & theme(legend.position = "bottom")

# -------------------------------------------------------------------
# 5. Save Output
# -------------------------------------------------------------------

figure_2_plot
```

```{r}
#| label: fig-3
#| fig-cap: "DCombined effects of 2-yr (2022-2023) pika and poisonous plant removal treatments on yak performance, forage quantity and quality in the field manipulated experiments. (a) yak weight gain, (b) S. chamaejasme cover, (c) grass cover, and (d) crude protein (CP) content of total forage based on dry mass. The average values of each variable in the two years were used for statistical analysis, providing a single data point for each variable in each 150 m × 150 m plot. (e) and (f) Show how S. chamaejasme abundance respond to the absence and presence of pika, respectively. Significant interactions between pika and S. chamaejasme plants were evaluated with post hoc comparisons; means that do not share letters are significantly different. Error bars represent +/- SE."
#| echo: false
#| results: asis
#| message: false
#| warning: false
#| fig-width: 10
#| fig-height: 8

# Layout design for final panel figure (2 rows × 3 columns)
layout <- "
ABC
DEF
"

# -------------------------------------------------------------------
# 2. Helper Functions
# -------------------------------------------------------------------

# Load a single CSV relative to project root
load_csv <- function(...) {
  read_csv(here(...), show_col_types = FALSE)
}

# Load a set of model outputs for a given base path
load_model_data <- function(base_path) {
  list(
    emms          = read_csv(file.path(base_path, "emms.csv")),
    letters       = read_csv(file.path(base_path, "posthoc_letters.csv")),
    model_summary = read_csv(file.path(base_path, "model_summary.csv")),
    contrasts     = read_csv(file.path(base_path, "posthoc_contrasts.csv"))
  )
}
# Generic plot for treatment × response with jitter, means, and letters
make_treatment_plot <- function(data, emms, letters, response_var, y_label, 
                                label_y = NULL, point_size = 4, text_size = 5) {

  # Figure out which column emms uses for the mean
  if ("response" %in% names(emms)) {
    emms <- emms |> mutate(.mean_val = response * 100)
  } else if ("emmean" %in% names(emms)) {
    emms <- emms |> mutate(.mean_val = emmean)
  } else {
    stop("emms must contain either 'response' or 'emmean' column")
  }

  # Set y-position for letters if not given
  label_y <- label_y %||% max(data[[response_var]], na.rm = TRUE)

  ggplot(data, aes(x = pika_treatment, y = .data[[response_var]], 
                   color = posion_plant_treatment)) +
    geom_jitter(
      size = 1, alpha = 0.4,
      position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.7)
    ) +
    geom_point(
      data = emms,
      aes(x = pika_treatment, y = .mean_val, fill = posion_plant_treatment),
      position = position_dodge(width = 0.7),
      size = point_size, pch = 21, color = "black", inherit.aes = FALSE
    ) +
    geom_text(
      data = letters,
      aes(x = pika_treatment, y = label_y, label = .group, group = posion_plant_treatment),
      position = position_dodge(width = 0.7),
      size = text_size, color = "black", show.legend = FALSE
    ) +
    scale_fill_manual(values = plant_colors) +
    scale_color_manual(values = plant_colors) +
    labs(x = NULL, y = y_label, color = NULL, fill = NULL) +
    theme_pubr(base_size = 10) +
    theme(legend.position = "bottom")
}


# -------------------------------------------------------------------
# 3. Data Loading
# -------------------------------------------------------------------

# Weight gain
weight_gain <- load_csv("data/processed/experiment_foraging_efficiency/yak_weight_gain.csv") |>
  mutate(yak = gsub("_[^_]*$", "", yak))

weight_gain_models <- load_model_data(
  here("data/processed/experiment_foraging_efficiency/modeled_data/weight_gain")
)

# Forage quality
forage_quality <- load_csv("data/processed/experiment_foraging_quality/plant_foraging_quality.csv")

quality_metrics <- c("cp", "adf", "ee")
forage_quality_models <- map(quality_metrics, ~ load_model_data(
  here(glue("data/processed/experiment_foraging_quality/modeled_data/{.x}"))
)) |> set_names(quality_metrics)

# Plant cover
cover_data <- load_csv("data/processed/experiment_plant_cover/plant_cover_by_treatment.csv")

grasses_models <- load_model_data(
  here("data/processed/experiment_plant_cover/modeled_data/grasses_cover")
)

poison_models <- load_model_data(
  here("data/processed/experiment_plant_cover/modeled_data/s_chamaejasme_cover")
)

# -------------------------------------------------------------------
# 4. Plot Panels
# -------------------------------------------------------------------

# Panel A: Yak weight gain
panel_a <- make_treatment_plot(
  data    = weight_gain,
  emms    = weight_gain_models$emms,
  letters = weight_gain_models$letters,
  response_var = "weight_gain",
  y_label = "Weight gain (kg/yak/day)",
  label_y = 0.60
)

# Panels B–D: Forage quality (CP, ADF, EE)
panel_d <- make_treatment_plot(
  data    = forage_quality |> filter(plant == "cp"),
  emms    = forage_quality_models$cp$emms,
  letters = forage_quality_models$cp$letters,
  response_var = "forage_quality",
  y_label = "CP (%)",
  label_y = 10
)

panel_e <- make_treatment_plot(
  data    = forage_quality |> filter(plant == "adf"),
  emms    = forage_quality_models$adf$emms,
  letters = forage_quality_models$adf$letters,
  response_var = "forage_quality",
  y_label = "ADF (%)",
  label_y = 36
)

panel_f <- make_treatment_plot(
  data    = forage_quality |> filter(plant == "ee"),
  emms    = forage_quality_models$ee$emms,
  letters = forage_quality_models$ee$letters,
  response_var = "forage_quality",
  y_label = "EE (%)",
  label_y = 4
)

# Panels E–F: Plant cover (grasses & poison plant)
panel_c <- make_treatment_plot(
  data    = cover_data |> filter(plant == "grasses"),
  emms    = grasses_models$emms,
  letters = grasses_models$letters,
  response_var = "cover",
  y_label = "Grass cover (%)",
  label_y = 41
)

panel_b <- make_treatment_plot(
  data    = cover_data |> filter(plant == "s_chamaejasme"),
  emms    = poison_models$emms,
  letters = poison_models$letters,
  response_var = "cover",
  y_label = expression(italic("S. chamaejasme") ~ "cover (%)"),
  label_y = 43
)

# -------------------------------------------------------------------
# 5. Combine into Figure
# -------------------------------------------------------------------

figure_3 <- panel_a +
  panel_b +
  panel_c +
  panel_d +
  panel_e +
  panel_f +
  plot_annotation(tag_levels = "A")  +
  plot_layout(design = layout, guides = "collect") & theme(legend.position = "bottom")

# Save output

figure_3

```

```{r}
#| label: fig-4
#| fig-cap: "Combined effects of 2-yr (2022-2023) pika and poisonous plant removal treatments on foraging efficiency of yak in the field manipulated experiments. (a) Total bite rate, (b) sedge bite rate, (c) grass bite rate, (d) total step rate, (e) sedge bites per step, and (f) grass bites per step. The average values of each variable in the two years were used for statistical analysis, providing a single data point for each variable in each 150 m × 150 m plot. Significant interactions between pika and S. chamaejasme plants were evaluated with post hoc comparisons; means that do not share letters are significantly different. Error bars represent +/- SE."
#| echo: false
#| results: asis
#| message: false
#| warning: false
#| fig-width: 10
#| fig-height: 8


# ============================================================
#                 DATA LOADING HELPERS
# ============================================================

# Generalized function for loading model outputs (emms, contrasts, etc.)
load_model_data <- function(base_dir, name) {
  base_path <- here(glue("{base_dir}/{name}"))
  list(
    emms          = read_csv(file.path(base_path, "emms.csv")),
    letters       = read_csv(file.path(base_path, "posthoc_letters.csv")),
    model_summary = read_csv(file.path(base_path, "model_summary.csv")),
    model_contrasts = read_csv(file.path(base_path, "posthoc_contrasts.csv"))
  )
}

# ============================================================
#                 PLANT BITE DATA
# ============================================================

# Load main plant bites dataset
plant_bites <- read_csv(here("data/processed/experiment_foraging_efficiency/yak_plant_bites.csv")) |>
  mutate(plant = gsub("_[^_]*$", '', plant))

# Load model outputs for each plant group
plant_groups <- c("forbs", "grasses", "sedges", "total")
plant_bites_models <- map(plant_groups,
                          ~ load_model_data("data/processed/experiment_foraging_efficiency/modeled_data/plant_bites",
                                            paste0(.x, "_plant_bites"))) |>
  set_names(plant_groups)

# Adjust letter groupings consistently
plant_bites_models <- map(plant_bites_models, function(x) {
  x$letters <- x$letters |> mutate(.group = ifelse(.group == "a", "b", "a"))
  x
})

# ============================================================
#                 BITE/STEPS DATA
# ============================================================

bite_steps <- read_csv(here("data/processed/experiment_foraging_efficiency/yak_bite_steps_ratio.csv"))

# Load model outputs for bite/step ratios
bite_step_groups <- c("forbs", "grasses", "sedges")
bite_step_models <- map(bite_step_groups,
                        ~ load_model_data("data/processed/experiment_foraging_efficiency/modeled_data/bite_steps",
                                          paste0(.x, "_bite_steps"))) |>
  set_names(bite_step_groups)

# Adjust letter groupings consistently
bite_step_models <- map(bite_step_models, function(x) {
  x$letters <- x$letters |>
    mutate(.group = ifelse(.group %in% c("a", "A"), "b", "a"))
  x
})

# ============================================================
#                 REUSABLE PLOTTING FUNCTIONS
# ============================================================
# --- Plant Bites Plot (panels A–C) ---
plot_plant_bites <- function(plant_name, y_label, label_y = NULL) {
  data <- plant_bites |> filter(plant == plant_name)
  model <- plant_bites_models[[plant_name]]
  
  # Standardize emms table
  emms <- model$emms
  if ("response" %in% names(emms)) {
    emms <- emms |> mutate(.mean_val = response * 100)
  } else if ("emmean" %in% names(emms)) {
    emms <- emms |> mutate(.mean_val = emmean)
  } else {
    stop("model$emms must contain either 'response' or 'emmean'")
  }
  
  # Standardize letters table
  letters <- model$letters
  if ("response" %in% names(letters)) {
    letters <- letters |> mutate(.mean_val = response)
  } else if ("emmean" %in% names(letters)) {
    letters <- letters |> mutate(.mean_val = emmean)
  } else {
    stop("model$letters must contain either 'response' or 'emmean'")
  }

  # Set default y-position for labels if not supplied
  label_y <- label_y %||% (max(data$forage_efficiency, na.rm = TRUE) + 0.05)

  data |>
    left_join(emms, by = c("pika_treatment", "posion_plant_treatment")) |>
    ggplot(aes(x = pika_treatment, y = forage_efficiency, 
               color = posion_plant_treatment)) +
    geom_jitter(
      size = 1, alpha = 0.4,
      position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.7)
    ) +
    geom_point(
      data = letters,
      aes(x = pika_treatment, y = .mean_val, fill = posion_plant_treatment),
      position = position_dodge(width = 0.7),
      size = 8, pch = 21, color = "black", inherit.aes = FALSE
    ) +
    geom_text(
      data = letters,
      aes(x = pika_treatment, y = label_y, label = .group, group = posion_plant_treatment),
      position = position_dodge(width = 0.7),
      size = 5, color = "black", show.legend = FALSE, inherit.aes = FALSE
    ) +
    scale_fill_manual(values = plant_colors) +
    scale_color_manual(values = plant_colors) +
    labs(
      y = y_label, x = "",
      color = "Poison plant treatment", fill = "Poison plant treatment"
    ) +
    theme_pubr(base_size = 15) +
    theme(legend.position = "bottom", legend.title = element_blank())
}


# --- Bite/Step Ratio Plot (panels E–F) ---
plot_bite_steps <- function(plant_name, y_label, label_y = NULL, add_letters = TRUE) {
  data <- bite_steps |> filter(plant == plant_name)
  model <- bite_step_models[[plant_name]]

  label_y <- label_y %||% max(data$bites_steps_ratio, na.rm = TRUE) + 0.05

  p <- data |>
    left_join(model$emms, by = c("pika_treatment", "posion_plant_treatment")) |>
    ggplot(aes(x = pika_treatment, y = bites_steps_ratio, color = posion_plant_treatment)) +
    geom_jitter(size = 1, alpha = 0.4,
                position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.7)) +
    geom_point(data = model$letters,
               aes(x = pika_treatment, y = response, fill = posion_plant_treatment),
               position = position_dodge(width = 0.7),
               size = 8, pch = 21, color = "black", inherit.aes = FALSE) +
    scale_fill_manual(values = plant_colors) +
    scale_color_manual(values = plant_colors) +
    labs(y = y_label, x = "", color = "Poison plant treatment", fill = "Poison plant treatment") +
    theme_pubr(base_size = 15) +
    theme(legend.position = "bottom", legend.title = element_blank())

  if (add_letters) {
    p <- p + geom_text(data = model$letters,
                       aes(x = pika_treatment, y = label_y, label = .group, group = posion_plant_treatment),
                       position = position_dodge(width = 0.7),
                       size = 5, color = "black", show.legend = FALSE)
  }
  p
}

# ============================================================
#                 TOTAL STEPS DATA
# ============================================================

total_steps <- read_csv(here("data/processed/experiment_foraging_efficiency/yak_total_steps.csv")) |>
  mutate(yak = gsub("_[^_]*$", '', yak))

total_steps_models <- load_model_data("data/processed/experiment_foraging_efficiency/modeled_data", "total_steps")

# Adjust letter groupings for clarity
total_steps_models$letters <- total_steps_models$letters |>
  mutate(.group = case_when(
    pika_treatment == "no pika" & posion_plant_treatment == "S. chamaejasme" ~ "b",
    TRUE ~ tolower(.group)
  ))

# --- Panel D ---
panel_d <- total_steps |>
  left_join(total_steps_models$emms, by = c("pika_treatment", "posion_plant_treatment")) |>
  ggplot(aes(x = pika_treatment, y = total_steps, color = posion_plant_treatment)) +
  geom_jitter(size = 1, alpha = 0.4,
              position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.7)) +
  geom_point(data = total_steps_models$letters,
             aes(x = pika_treatment, y = emmean, fill = posion_plant_treatment),
             position = position_dodge(width = 0.7),
             size = 8, pch = 21, color = "black", inherit.aes = FALSE) +
  geom_text(data = total_steps_models$letters,
            aes(x = pika_treatment, y = 1000, label = .group, group = posion_plant_treatment),
            position = position_dodge(width = 0.7),
            size = 5, color = "black", show.legend = FALSE, inherit.aes = FALSE) +
  scale_fill_manual(values = plant_colors) +
  scale_color_manual(values = plant_colors) +
  labs(y = "Total steps", x = "", color = "Poison plant treatment", fill = "Poison plant treatment") +
  theme_pubr(base_size = 15) +
  theme(legend.position = "bottom", legend.title = element_blank())

# ============================================================
#                 COMBINE PANELS
# ============================================================

# Generate bite panels
panel_a <- plot_plant_bites("total", "Total bites", label_y = 800)
panel_b <- plot_plant_bites("sedges", "Sedge bites", label_y = 450)
panel_c <- plot_plant_bites("grasses", "Grass bites", label_y = 350)

# Generate bite/step panels
panel_e <- plot_bite_steps("sedges", "Sedges bite/steps", label_y = 1)
panel_f <- plot_bite_steps("grasses", "Grass bite/steps")

# Layout specification
layout <- "
ABC
DEF
"

figure_4 <- panel_a + panel_b + panel_c +
            panel_d + panel_e + panel_f +
            plot_annotation(tag_levels = "A") +
            plot_layout(design = layout, guides = "collect") &
            theme(legend.position = "bottom")

figure_4

```


# Supplementary Figures and Tables



::: {#supptbl-pika-feeding-model-summary}
```{r}
#| echo: false
#| reulsts: 'asis'
#| message: false
#| warning: false

library(knitr)
library(kableExtra)
pika_feeding_model_summary <- read_csv(here('data/processed/diet_selection/modeled_data/pika_feeding/model_summary.csv'),show_col_types = FALSE)

pika_feeding_model_summary |>
  kable(format = "html", booktabs = TRUE, digits = 2) |>
  kable_styling(latex_options = c("striped"))
```

Model summary for pika feeding.
::: 



::: {#supptbl-pika-feeding-model-contrast}
```{r}
#| echo: false
#| reulsts: 'asis'
#| message: false
#| warning: false
library(knitr)
library(kableExtra)

pika_feeding_contrasts <- read_csv(here('data/processed/diet_selection/modeled_data/pika_feeding/posthoc_contrasts.csv'))

pika_feeding_contrasts |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped"))


```

Model contrasts for pika feeding.
::: 



::: {#supptbl-yak-feeding-model-summary}
```{r}
#| label: tbl-yak-feeding-model-summary
#| tbl-cap: "Model summary for yak grazing by plant group"
#| echo: false
#| reulsts: asis'
#| message: false
#| warning: false

library(knitr)
library(kableExtra)

yak_feeding_model_summary <- read_csv(here('data/processed/diet_selection/modeled_data/yak_grazing/model_summary.csv'))

yak_feeding_model_summary |>
  kable(format = "html", booktabs = TRUE, digits = 2) |>
  kable_styling(latex_options = c("striped"))
```

Model summary for yak grazing.
::: 

::: {#supptbl-yak-feeding-model-contrast}
```{r}
#| label: tbl-yak-feeding-model-contrasts
#| tbl-cap: "Estimated marginal means contrasts for yak grazing by plant group"
#| echo: false
#| reulsts: 'asis'
#| message: false
#| warning: false
library(knitr)
library(kableExtra)

yak_feeding_contrasts <- read_csv(here('data/processed/diet_selection/modeled_data/yak_grazing/posthoc_contrasts.csv'),show_col_types = FALSE)

yak_feeding_contrasts |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped"))


```

Model contrasts for yak grazing.
::: 


::: {#supptbl-yak-weight-gain-model-summary}
```{r}
#| label: tbl-weight-gain-model-summary
#| tbl-cap: "Model summary for weight gain."
#| echo: false
#| message: false
#| warning: false


# Define a function to load model data for a plant group
load_data <- function(base_path) {
  list(
    emms = read_csv(file.path(base_path, "emms.csv")),
    letters = read_csv(file.path(base_path, "posthoc_letters.csv")),
    model_summary = read_csv(file.path(base_path, "model_summary.csv")),
    model_contrasts = read_csv(file.path(base_path, "posthoc_contrasts.csv"))
  )
}

weight_gain_models <- load_data(here('data/processed/experiment_foraging_efficiency/modeled_data/weight_gain'))


weight_gain_models$model_summary  |>
  mutate(
    term = case_when(
        term == 'pika_treatmentpika' ~ 'pika',
        term == 'posion_plant_treatmentS. chamaejasme' ~ 'poison plant',
        term == 'pika_treatmentpika:posion_plant_treatmentS. chamaejasme' ~ 'pika : poison treamtent',
        effect == 'ran_pars' ~ group,
        TRUE ~ term
    )
  ) |>
  select(!c(component,group)) |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```


Model summary for yak weight gain.
::: 



```{r, reading in cover data}
#| echo: false
#| results: "hide"
#| message: false
#| warning: falseß

grasses_emms <- read_csv(here('data/processed/experiment_plant_cover/modeled_data/grasses_cover/emms.csv'))
grasses_letters <- read_csv(here('data/processed/experiment_plant_cover/modeled_data/grasses_cover/posthoc_letters.csv'))
grasses_model_summary  <- read_csv(here('data/processed/experiment_plant_cover/modeled_data/grasses_cover/model_summary.csv'))
grasses_model_contrasts  <- read_csv(here('data/processed/experiment_plant_cover/modeled_data/grasses_cover/posthoc_contrasts.csv'))

poison_emms <- read_csv(here('data/processed/experiment_plant_cover/modeled_data/s_chamaejasme_cover/emms.csv'))
poison_letters <- read_csv(here('data/processed/experiment_plant_cover/modeled_data/s_chamaejasme_cover/posthoc_letters.csv'))
poison_model_summary  <- read_csv(here('data/processed/experiment_plant_cover/modeled_data/s_chamaejasme_cover/model_summary.csv'))
poison__model_contrasts  <- read_csv(here('data/processed/experiment_plant_cover/modeled_data/s_chamaejasme_cover/posthoc_contrasts.csv'))

```


::: {#supptbl-grass-cover-model-summary}
```{r}
#| label: tbl-grasses-model-summary
#| tbl-cap: "Model summary for grass cover."
#| echo: false
#| message: false
#| warning: false

grasses_model_summary |>
  mutate(
    term = case_when(
        term == 'pika_treatmentpika' ~ 'pika',
        term == 'posion_plant_treatmentS. chamaejasme' ~ 'poison plant',
        term == 'pika_treatmentpika:posion_plant_treatmentS. chamaejasme' ~ 'pika : poison treamtent',
        effect == 'ran_pars' ~ group,
        TRUE ~ term
    )
  ) |>
  select(!c(component,group)) |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```

Model summary for Grass cover.
::: 

::: {#supptbl-grass-cover-contrasts}
```{r}
#| label: tbl-grasses-model-contrasts
#| tbl-cap: "Estimated marginal means contrasts for grass cover by treatment group."
#| echo: false
#| message: false
#| warning: false

grasses_model_contrasts |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```

Model contrasts for Grass cover.
::: 



::: {#supptbl-poison-cover-summary}
```{r}
#| label: tbl-poison-model-summary
#| tbl-cap: "Model summary for *S. chamaejasme* cover."
#| echo: false
#| message: false
#| warning: false

poison_model_summary |>
  mutate(
    term = case_when(
        term == 'pika_treatmentpika' ~ 'pika',
        term == 'posion_plant_treatmentS. chamaejasme' ~ 'poison plant',
        term == 'pika_treatmentpika:posion_plant_treatmentS. chamaejasme' ~ 'pika : poison treamtent',
        effect == 'ran_pars' ~ group,
        TRUE ~ term
    )
  ) |>
  select(!c(component,group)) |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```

Model summary for *S. chamaejasme* cover.
::: 


::: {#supptbl-poison-cover-contrasts}
```{r}
#| label: tbl-poison-model-contrasts
#| tbl-cap: "Estimated marginal means contrasts for *S. chamaejasme* cover by treatment group."
#| echo: false
#| message: false
#| warning: false

poison__model_contrasts |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```

Model contrasts for *S. chamaejasme* cover.
::: 


::: {#supptbl-yak-weight-gain-model-contrast}
```{r}
#| label: tbl-weight-gain-model-contrasts
#| tbl-cap: "Estimated marginal means contrasts for weight gain by treatment group."
#| echo: false
#| message: false
#| warning: false

weight_gain_models$model_contrasts |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```

Model contrasts for yak weight gain.
::: 




::: {#supptbl-adf-model-summary}
```{r}
#| echo: false
#| message: false
#| warning: false


# Define a function to load model data for a plant group
load_forage_quality_data <- function(quality_metric) {
  base_path <- here(glue::glue("data/processed/experiment_foraging_quality/modeled_data/{quality_metric}"))
  list(
    emms = read_csv(file.path(base_path, "emms.csv")),
    letters = read_csv(file.path(base_path, "posthoc_letters.csv")),
    model_summary = read_csv(file.path(base_path, "model_summary.csv")),
    model_contrasts = read_csv(file.path(base_path, "posthoc_contrasts.csv"))
  )
}


# Define your plant groups
quality_metrics <- c("adf", "cp", "ee","ndf")

# Load all model data into a named list
forag_quality_models <- map(quality_metrics, load_forage_quality_data) |> set_names(quality_metrics)

forag_quality_models$adf$model_summary |>
  mutate(
    term = case_when(
        term == 'pika_treatmentpika' ~ 'pika',
        term == 'posion_plant_treatmentS. chamaejasme' ~ 'poison plant',
        term == 'pika_treatmentpika:posion_plant_treatmentS. chamaejasme' ~ 'pika : poison treamtent',
        effect == 'ran_pars' ~ group,
        TRUE ~ term
    )
  ) |>
  kable(format = "html", booktabs = TRUE, digits = 3)|>
  kable_styling(latex_options = c("striped","scale_down"))
```

Model summary for ADF.
::: 


::: {#supptbl-adf-model-contrast}
```{r}
#| echo: false
#| message: false
#| warning: false

forag_quality_models$adf$model_contrasts |>
  kable(format = "html", booktabs = TRUE, digits = 3)|>
  kable_styling(latex_options = c("striped","scale_down"))
```

Model contrasts for ADF.
::: 


::: {#supptbl-cp-model-summary}
```{r}
#| echo: false
#| message: false
#| warning: false


forag_quality_models$cp$model_summary |>
  mutate(
    term = case_when(
        term == 'pika_treatmentpika' ~ 'pika',
        term == 'posion_plant_treatmentS. chamaejasme' ~ 'poison plant',
        term == 'pika_treatmentpika:posion_plant_treatmentS. chamaejasme' ~ 'pika : poison treamtent',
        effect == 'ran_pars' ~ group,
        TRUE ~ term
    )
  ) |>
  kable(format = "html", booktabs = TRUE, digits = 3)|>
  kable_styling(latex_options = c("striped","scale_down"))
```

Model summary for CP.
::: 


::: {#supptbl-cp-model-contrasts}
```{r}
#| echo: false
#| message: false
#| warning: false

forag_quality_models$cp$model_contrasts |>
  kable(format = "html", booktabs = TRUE, digits = 3)|>
  kable_styling(latex_options = c("striped","scale_down"))
```

Model contrasts for CP.
::: 


::: {#supptbl-ee-model-summary}
```{r}
#| echo: false
#| message: false
#| warning: false


forag_quality_models$ee$model_summary |>
  mutate(
    term = case_when(
        term == 'pika_treatmentpika' ~ 'pika',
        term == 'posion_plant_treatmentS. chamaejasme' ~ 'poison plant',
        term == 'pika_treatmentpika:posion_plant_treatmentS. chamaejasme' ~ 'pika : poison treamtent',
        effect == 'ran_pars' ~ group,
        TRUE ~ term
    )
  ) |>
  kable(format = "html", booktabs = TRUE, digits = 3)|>
  kable_styling(latex_options = c("striped","scale_down"))
```

Model summary for EE.
::: 

::: {#supptbl-ee-model-contrasts}
```{r}
#| label: tbl-ee-model-contrasts
#| tbl-cap: "Estimated marginal means contrasts for EE by treatment group."
#| echo: false
#| message: false
#| warning: false

forag_quality_models$ee$model_contrasts |>
  kable(format = "html", booktabs = TRUE, digits = 3)|>
  kable_styling(latex_options = c("striped","scale_down"))
```

Model contrasts for EE.
::: 
