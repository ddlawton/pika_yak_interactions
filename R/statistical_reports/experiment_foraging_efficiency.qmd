---
title: "Foraging Efficiency: Exploratory Analysis"
author: "Douglas Lawton"
date: today
format:
  html:
    toc: true
    toc-depth: 2
    number-sections: true
    fig-cap-location: bottom
    theme: cosmo
editor: source
---

::: {.callout-note}
## About This Report

This report documents the exploratory analysis of foraging efficiency data that informed the final manuscript analyses. The finalized methods, results, and figures are presented in the **Methods and Results** document.
:::

```{r}
#| echo: false
#| results: "hide"
#| message: false
#| warning: false

library(tidyverse)
library(ggpubr)
library(patchwork)
library(here)
library(mgcv)
library(knitr)
library(kableExtra)

# --- Set Root Directory for Project ---
here::i_am("README.md")  # Anchor project for reproducible paths

# --- Custom Color Palette ---
pink <- '#ff8080'
green <- '#2fc09b'

```

# Bite Steps

```{r}
#| echo: false
#| results: "hide"
#| message: false
#| warning: false

# Load the bite_steps dataset once
bite_steps <- read_csv(here("data/processed/experiment_foraging_efficiency/yak_bite_steps_ratio.csv"))

# Define a function to load model data for a plant group
load_bite_step_data <- function(plant) {
  base_path <- here(glue::glue("data/processed/experiment_foraging_efficiency/modeled_data/bite_steps/{plant}_bite_steps"))
  list(
    emms = read_csv(file.path(base_path, "emms.csv")),
    letters = read_csv(file.path(base_path, "posthoc_letters.csv")),
    model_summary = read_csv(file.path(base_path, "model_summary.csv")),
    model_contrasts = read_csv(file.path(base_path, "posthoc_contrasts.csv"))
  )
}

# Define your plant groups
plant_groups <- c("forbs", "grasses", "sedges")

# Load all model data into a named list
bite_step_models <- map(plant_groups, load_bite_step_data) |> set_names(plant_groups)

```

The following figure (@fig-bite_step_figures) shows the relationship between yak bite/step ratios per plant across he pika and poison plant treatments. We see decreased bite/step ratios for grasses and sedges within the no pika and poison plant treatment plots. Whereas all other treatment levels had a consistent bite/step ratio. Forbs is an exception where there is no difference except with increase forb bite/step ratio in the pika x poison plant treatment level.

```{r}
#| label: fig-bite_step_figures
#| fig-cap: "diet selection"
#| echo: false
#| reulsts: asis'
#| message: false
#| warning: false
#| fig-width: 8
#| fig-height: 8

# Define your color palette
plant_colors <- c(green, pink)

# Reusable function
plot_bite_steps <- function(plant_name, y_label, label_y = NULL, letters = TRUE)  {
  data <- bite_steps |> filter(plant == plant_name)
  emms <- bite_step_models[[plant_name]]$emms
  letters_df <- bite_step_models[[plant_name]]$letters

  label_y <- label_y %||% max(data$bites_steps_ratio, na.rm = TRUE) + 0.05

  p <- data |>
    left_join(emms, by = c('pika_treatment', 'posion_plant_treatment')) |>
    ggplot(aes(x = pika_treatment, y = bites_steps_ratio, color = posion_plant_treatment)) +
    geom_jitter(
      size = 1, alpha = 0.4,
      position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.7)
    ) +
    geom_point(
      data = letters_df,
      aes(x = pika_treatment, y = response, fill = posion_plant_treatment),
      position = position_dodge(width = 0.7),
      size = 8, pch = 21, color = "black", inherit.aes = FALSE
    ) +
    scale_fill_manual(values = plant_colors) +
    scale_color_manual(values = plant_colors) +
    labs(
      y = y_label,
      x = "",
      color = "Poison plant treatment",
      fill = "Poison plant treatment"
    ) +
    theme_pubr(base_size = 15) +
    theme(legend.position = "bottom", legend.title = element_blank())

    if (letters) {
        p <- p  +
        geom_text(
            data = letters_df,
            aes(x = pika_treatment, y = label_y, label = .group, group = posion_plant_treatment),
            position = position_dodge(width = 0.7),
            size = 5, color = "black", show.legend = FALSE
        )
  }

  p
}

# Call the function for each plant type
grasses_plot <- plot_bite_steps("grasses", "grass bite/steps")
sedges_plot  <- plot_bite_steps("sedges", "sedges bite/steps", label_y = 1)
forbs_plot   <- plot_bite_steps("forbs", "forbs bite/steps", label_y = 0.4,letters=FALSE)



(grasses_plot + sedges_plot) / (forbs_plot + plot_spacer()) + 
  plot_annotation(tag_levels = 'A') + 
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')



```

## Grass Bite Steps

The model revealed that the presence of *S. chamaejasme* significantly reduced yak grass feeding efficiency (bite/step ratio) (@tbl-grasses-bite-step-model-summary), but this negative effect was mitigated when pikas were present, as shown by a significant positive interaction (@tbl-grasses-bite-step-model-summary). Pika presence alone did not influence feeding efficiency; however, in combination with *S. chamaejasme*, it substantially improved it (@tbl-grasses-bite-step-model-contrasts). These results suggest that pikas may facilitate yak foraging by offsetting the detrimental effects of poisonous plants.

## Sedge Bite Steps

The presence of *S. chamaejasme* significantly reduced yak feeding efficiency on sedges, as shown by a strong negative main effect in the model summary (@tbl-sedges-bite-step-model-summary). Although pika presence alone had no effect, the significant positive interaction indicates that pikas mitigated the negative impact of the poisonous plant. Specifically, sedge bite/step ratios were much lower when *S. chamaejasme* was present without pikas, but this reduction was substantially less when pikas were present (see pairwise contrasts in @tbl-sedges-bite-step-model-contrasts). These findings suggest that pikas facilitate yak foraging on sedges by reducing the negative effects of *S. chamaejasme*.

## Forbs Bite Steps

For forbs, neither pika presence nor *S. chamaejasme* alone significantly affected yak feeding efficiency, as both main effects were non-significant (see @tbl-forbs-bite-step-model-summary). However, there was a marginally non-significant interaction (p = 0.067), suggesting a possible moderating effect of pikas on the impact of the poisonous plant. In the pairwise contrasts, the bite/step ratio was significantly lower when *S. chamaejasme* was present and pikas were absent compared to when both were present (see @tbl-forbs-bite-step-model-contrasts). This indicates a weaker but still detectable facilitative effect of pikas on yak forb consumption in the presence of *S. chamaejasme*.

# Plant bites

```{r}
#| echo: false
#| results: "hide"
#| message: false
#| warning: false

# Load the bite_steps dataset once
plant_bites <- read_csv(here("data/processed/experiment_foraging_efficiency/yak_plant_bites.csv")) |>
  mutate(plant = gsub("_[^_]*$", '',plant))

# Define a function to load model data for a plant group
load_plant_bites_data <- function(plant) {
  base_path <- here(glue::glue("data/processed/experiment_foraging_efficiency/modeled_data/plant_bites/{plant}_plant_bites"))
  list(
    emms = read_csv(file.path(base_path, "emms.csv")),
    letters = read_csv(file.path(base_path, "posthoc_letters.csv")),
    model_summary = read_csv(file.path(base_path, "model_summary.csv")),
    model_contrasts = read_csv(file.path(base_path, "posthoc_contrasts.csv"))
  )
}


# Define your plant groups
plant_groups <- c("forbs", "grasses", "sedges")

# Load all model data into a named list
plant_bites_models <- map(plant_groups, load_plant_bites_data) |> set_names(plant_groups)

```

The following figure (@fig-bite_step_figures) shows the relationship between yak bite/step ratios per plant across the pika and poison plant treatments. We observe decreased bite/step ratios for grasses and sedges in the no-pika and poison plant treatment plots, while all other treatment levels exhibited consistent bite/step ratios. For forbs, there was no difference except for an increased bite/step ratio in the pika × poison plant treatment level.


```{r}
#| label: fig-plant_bites_figures
#| fig-cap: "yak plant bites by plant group"
#| echo: false
#| reulsts: asis
#| message: false
#| warning: false
#| fig-width: 8
#| fig-height: 8

# Define your color palette
plant_colors <- c(green, pink)

# Reusable function

plot_plant_bites <- function(plant_name, y_label, label_y = NULL) {
  data <- plant_bites |> filter(plant == plant_name)
  emms <- plant_bites_models[[plant_name]]$emms
  letters <- plant_bites_models[[plant_name]]$letters

  if ("emmean" %in% names(emms)) {
    emms <- emms |> rename(response = emmean)
    letters <- letters |> rename(response = emmean)
  }

  label_y <- label_y %||% max(data$forage_efficiency, na.rm = TRUE) + 0.05

  data |>
    left_join(emms, by = c('pika_treatment', 'posion_plant_treatment')) |>
    ggplot(aes(x = pika_treatment, y = forage_efficiency, color = posion_plant_treatment)) +
    geom_jitter(
      size = 1, alpha = 0.4,
      position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.7)
    ) +
    geom_point(
      data = letters,
      aes(x = pika_treatment, y = response, fill = posion_plant_treatment),
      position = position_dodge(width = 0.7),
      size = 8, pch = 21, color = "black", inherit.aes = FALSE
    ) +
    geom_text(
      data = letters,
      aes(x = pika_treatment, y = label_y, label = .group, group = posion_plant_treatment),
      position = position_dodge(width = 0.7),
      size = 5, color = "black", show.legend = FALSE, inherit.aes = FALSE
    ) +
    scale_fill_manual(values = plant_colors) +
    scale_color_manual(values = plant_colors) +
    labs(
      y = y_label,
      x = "",
      color = "Poison plant treatment",
      fill = "Poison plant treatment"
    ) +
    theme_pubr(base_size = 15) +
    theme(legend.position = "bottom", legend.title = element_blank())
}

# Call the function for each plant type
grasses_plot <- plot_plant_bites("grasses", "grass bites", label_y = 350)
sedges_plot  <- plot_plant_bites("sedges", "sedge bites", label_y = 410)
forbs_plot   <- plot_plant_bites("forbs", "forb bites", label_y = 200)



(grasses_plot + sedges_plot) / (forbs_plot + plot_spacer()) + 
  plot_annotation(tag_levels = 'A') + 
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')



```

## Grass Plant Bites

Yak grazing on grasses was significantly reduced by the presence of the poisonous plant *S. chamaejasme*, with a large negative estimate (-45.3) indicating fewer bites in treated plots. The pika treatment alone had no significant effect on grass bites. However, the interaction between pika presence and *S. chamaejasme* treatment was positive and significant (+43.9), suggesting that pika presence mitigates the negative effect of the poisonous plant on grass bites. Contrasts confirm that plots with *S. chamaejasme* had substantially lower grazing, except when pikas were present, which restored grazing levels.

## Forb Plant Bites

Yak bites on forbs were generally low and showed no significant differences across pika or poisonous plant treatments. The *S. chamaejasme* treatment showed a marginally positive effect on forb bites, but this was not statistically significant (p ~ 0.058). The interaction between pika and *S. chamaejasme* was also non-significant. Overall, yak grazing on forbs appears unaffected by either treatment or their interaction.

## Sedge Plant Bites

Grazing on sedges was significantly reduced by *S. chamaejasme* treatment (estimate = -0.42), indicating fewer yak bites in plots with the poisonous plant. Pika presence alone had no significant effect, but the pika × *S. chamaejasme* interaction was strongly positive (+0.36), showing that pika presence offsets the reduction caused by the poisonous plant. Contrasts reveal that sedge grazing decreases with *S. chamaejasme* unless pikas are present, which helps maintain grazing levels.

# weight gain

```{r}
#| label: loading in steps and weight data
#| echo: false
#| results: "hide"
#| message: false
#| warning: false

weight_gain <- read_csv(here("data/processed/experiment_foraging_efficiency/yak_weight_gain.csv")) |>
  mutate(yak = gsub("_[^_]*$", '',yak))

# Define a function to load model data for a plant group
load_data <- function(base_path) {
  list(
    emms = read_csv(file.path(base_path, "emms.csv")),
    letters = read_csv(file.path(base_path, "posthoc_letters.csv")),
    model_summary = read_csv(file.path(base_path, "model_summary.csv")),
    model_contrasts = read_csv(file.path(base_path, "posthoc_contrasts.csv"))
  )
}


weight_gain_models <- load_data(here('data/processed/experiment_foraging_efficiency/modeled_data/weight_gain'))
```

```{r}
#| label: fig-weight-gain
#| fig-cap: "Yak weight gain by treatment"
#| echo: false
#| reulsts: asis
#| message: false
#| warning: false
#| fig-width: 10
#| fig-height: 8

weight_gain_plot <- weight_gain |>
  left_join(weight_gain_models$emms, by = c('pika_treatment', 'posion_plant_treatment')) |>
  ggplot(aes(x = pika_treatment, y = weight_gain, color = posion_plant_treatment)) +
  geom_jitter(
    size = 1, alpha = 0.4,
    position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.7)
  ) +
  geom_point(
    data = weight_gain_models$letters,
    aes(x = pika_treatment, y = emmean, fill = posion_plant_treatment),
    position = position_dodge(width = 0.7),
    size = 8, pch = 21, color = "black", inherit.aes = FALSE
  ) +
  geom_text(
    data = weight_gain_models$letters,
    aes(x = pika_treatment, y = 1, label = .group, group = posion_plant_treatment),
    position = position_dodge(width = 0.7),
    size = 5, color = "black", show.legend = FALSE, inherit.aes = FALSE
  ) +
  scale_fill_manual(values = plant_colors) +
  scale_color_manual(values = plant_colors) +
  labs(
    y = 'weight gain (kg/yak/day)',
    x = "",
    color = "Poison plant treatment",
    fill = "Poison plant treatment"
  ) +
  theme_pubr(base_size = 15) +
  theme(legend.position = "bottom", legend.title = element_blank())

(weight_gain_plot) + 
  plot_annotation(tag_levels = 'A') + 
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')


```



## Weight Gain Summary

The poisonous plant *S. chamaejasme* substantially reduced yak weight gain, with a mean loss of 0.108 kg/day compared to control plots without the plant, while pika presence alone had no significant effect on weight gain (@tbl-weight-gain-model-summary). However, the strong positive interaction term (+0.132 kg/day) indicates that pika presence largely neutralizes the negative effect of *S. chamaejasme*, resulting in weight gain similar to control conditions. Contrasts show that while *S. chamaejasme* sharply reduces weight gain in the absence of pikas, this reduction disappears when pikas are present, suggesting a facilitative role of pikas in mitigating plant-induced losses (@tbl-weight-gain-model-contrasts).

# tables

```{r}
#| label: tbl-grasses-bite-step-model-summary
#| tbl-cap: "Model summary for grass bite/steps."
#| echo: false
#| message: false
#| warning: false

bite_step_models$grasses$model_summary |>
  mutate(
    term = case_when(
        term == 'pika_treatmentpika' ~ 'pika',
        term == 'posion_plant_treatmentS. chamaejasme' ~ 'poison plant',
        term == 'pika_treatmentpika:posion_plant_treatmentS. chamaejasme' ~ 'pika : poison treamtent',
        effect == 'ran_pars' ~ group,
        TRUE ~ term
    )
  ) |>
  select(!c(component,group)) |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```

```{r}
#| label: tbl-grasses-bite-step-model-contrasts
#| tbl-cap: "Estimated marginal means contrasts for grass bite/steps by treatment group."
#| echo: false
#| message: false
#| warning: false

bite_step_models$grasses$model_contrasts |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```

```{r}
#| label: tbl-sedges-bite-step-model-summary
#| tbl-cap: "Model summary for sedge bite/steps."
#| echo: false
#| message: false
#| warning: false

bite_step_models$sedges$model_summary |>
  mutate(
    term = case_when(
        term == 'pika_treatmentpika' ~ 'pika',
        term == 'posion_plant_treatmentS. chamaejasme' ~ 'poison plant',
        term == 'pika_treatmentpika:posion_plant_treatmentS. chamaejasme' ~ 'pika : poison treamtent',
        effect == 'ran_pars' ~ group,
        TRUE ~ term
    )
  ) |>
  select(!c(component,group)) |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```

```{r}
#| label: tbl-sedges-bite-step-model-contrasts
#| tbl-cap: "Estimated marginal means contrasts for sedge bite/steps by treatment group."
#| echo: false
#| message: false
#| warning: false

bite_step_models$sedges$model_contrasts |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```

```{r}
#| label: tbl-forbs-bite-step-model-summary
#| tbl-cap: "Model summary for forbs bite/steps."
#| echo: false
#| message: false
#| warning: false

bite_step_models$forbs$model_summary  |>
  mutate(
    term = case_when(
        term == 'pika_treatmentpika' ~ 'pika',
        term == 'posion_plant_treatmentS. chamaejasme' ~ 'poison plant',
        term == 'pika_treatmentpika:posion_plant_treatmentS. chamaejasme' ~ 'pika : poison treamtent',
        effect == 'ran_pars' ~ group,
        TRUE ~ term
    )
  ) |>
  select(!c(component,group)) |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```

```{r}
#| label: tbl-forbs-bite-step-model-contrasts
#| tbl-cap: "Estimated marginal means contrasts for forbs bite/steps by treatment group."
#| echo: false
#| message: false
#| warning: false

bite_step_models$forbs$model_contrasts |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```

```{r}
#| label: tbl-grasses-plant-bites-model-summary
#| tbl-cap: "Model summary for overall grass bites."
#| echo: false
#| message: false
#| warning: false


plant_bites_models$grasses$model_summary  |>
  mutate(
    term = case_when(
        term == 'pika_treatmentpika' ~ 'pika',
        term == 'posion_plant_treatmentS. chamaejasme' ~ 'poison plant',
        term == 'pika_treatmentpika:posion_plant_treatmentS. chamaejasme' ~ 'pika : poison treamtent',
        effect == 'ran_pars' ~ group,
        TRUE ~ term
    )
  ) |>
  select(!c(component,group)) |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```

```{r}
#| label: tbl-grasses-plant-bite-model-contrasts
#| tbl-cap: "Estimated marginal means contrasts for overall grass bites."
#| echo: false
#| message: false
#| warning: false

plant_bites_models$grasses$model_contrasts |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```

```{r}
#| label: tbl-forbs-plant-bites-model-summary
#| tbl-cap: "Model summary for overall forb bites."
#| echo: false
#| message: false
#| warning: false


plant_bites_models$forbs$model_summary  |>
  mutate(
    term = case_when(
        term == 'pika_treatmentpika' ~ 'pika',
        term == 'posion_plant_treatmentS. chamaejasme' ~ 'poison plant',
        term == 'pika_treatmentpika:posion_plant_treatmentS. chamaejasme' ~ 'pika : poison treamtent',
        effect == 'ran_pars' ~ group,
        TRUE ~ term
    )
  ) |>
  select(!c(component,group)) |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```

```{r}
#| label: tbl-sedges-plant-bites-model-summary
#| tbl-cap: "Model summary for overall sedge bites."
#| echo: false
#| message: false
#| warning: false


plant_bites_models$sedges$model_summary  |>
  mutate(
    term = case_when(
        term == 'pika_treatmentpika' ~ 'pika',
        term == 'posion_plant_treatmentS. chamaejasme' ~ 'poison plant',
        term == 'pika_treatmentpika:posion_plant_treatmentS. chamaejasme' ~ 'pika : poison treamtent',
        effect == 'ran_pars' ~ group,
        TRUE ~ term
    )
  ) |>
  select(!c(component,group)) |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```

```{r}
#| label: tbl-sedges-plant-bite-model-contrasts
#| tbl-cap: "Estimated marginal means contrasts for overall sedge bites by treatment group."
#| echo: false
#| message: false
#| warning: false

plant_bites_models$sedges$model_contrasts |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```

```{r}
#| label: tbl-weight-gain-model-summary
#| tbl-cap: "Model summary for weight gain."
#| echo: false
#| message: false
#| warning: false


weight_gain_models$model_summary  |>
  mutate(
    term = case_when(
        term == 'pika_treatmentpika' ~ 'pika',
        term == 'posion_plant_treatmentS. chamaejasme' ~ 'poison plant',
        term == 'pika_treatmentpika:posion_plant_treatmentS. chamaejasme' ~ 'pika : poison treamtent',
        effect == 'ran_pars' ~ group,
        TRUE ~ term
    )
  ) |>
  select(!c(component,group)) |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```

```{r}
#| label: tbl-weight-gain-model-contrasts
#| tbl-cap: "Estimated marginal means contrasts for weight gain by treatment group."
#| echo: false
#| message: false
#| warning: false

weight_gain_models$model_contrasts |>
  kable(format = "html", booktabs = TRUE, digits = 3) |>
  kable_styling(latex_options = c("striped","scale_down"))
```